<!-- templates/chatbot/chatbot_widget.html -->
{% load static %}
{% load chatbot_tags %}

<!-- Crisis Alert Banner -->
{% if has_crisis_alert %}
<div class="position-fixed top-0 start-0 end-0 bg-danger text-white py-3 shadow" style="z-index: 1050;">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-auto">
                <i class="bi bi-exclamation-triangle-fill fs-4"></i>
            </div>
            <div class="col">
                <strong class="d-block">CRISIS ALERT</strong>
                <small>Emergency support has been notified. Help is on the way.</small>
            </div>
            <div class="col-auto">
                <a href="tel:999" class="btn btn-light btn-sm me-2">
                    <i class="bi bi-telephone-fill"></i> 999
                </a>
                <a href="tel:1199" class="btn btn-light btn-sm">
                    <i class="bi bi-hospital-fill"></i> 1199
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Floating Chatbot Button -->
<button 
    id="chatbot-toggle-btn" 
    class="btn btn-primary chatbot-float-btn"
    type="button"
    aria-label="Open AI Assistant"
>
    <i class="bi bi-robot fs-4"></i>
    {% if is_authenticated and unread_count > 0 %}
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
        {{ unread_count }}
    </span>
    {% endif %}
</button>

<!-- Chatbot Window -->
<div id="chatbot-window" class="chatbot-window d-none">
    <div class="card border-0 h-100">
        <!-- Header -->
        <div class="card-header bg-primary text-white border-0">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="avatar-circle bg-white text-primary me-2">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div>
                        <h6 class="mb-0 fw-semibold">AI Assistant</h6>
                        <small class="d-flex align-items-center">
                            <i class="bi bi-circle-fill text-success me-1" style="font-size: 0.4rem;"></i>
                            Online
                        </small>
                    </div>
                </div>
                <div class="btn-group" role="group">
                    <button 
                        type="button" 
                        class="btn btn-sm btn-outline-light border-0" 
                        id="minimize-btn"
                        title="Minimize"
                    >
                        <i class="bi bi-dash-lg"></i>
                    </button>
                    <button 
                        type="button" 
                        class="btn btn-sm btn-outline-light border-0" 
                        id="new-conversation-btn"
                        title="New Conversation"
                    >
                        <i class="bi bi-plus-lg"></i>
                    </button>
                    <button 
                        type="button" 
                        class="btn btn-sm btn-outline-light border-0" 
                        id="close-btn"
                        title="Close"
                    >
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-light border-bottom px-3 py-2">
            <div class="d-flex gap-2 overflow-auto quick-actions-container">
                {% for action in chatbot_quick_actions %}
                <button 
                    type="button"
                    class="btn btn-sm btn-outline-secondary flex-shrink-0 quick-action-btn"
                    data-action="{{ action.action }}"
                >
                    <i class="bi bi-{{ action.icon }} me-1"></i>
                    {{ action.label }}
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- Messages Container -->
        <div id="chatbot-messages" class="flex-grow-1 overflow-auto p-3 messages-container">
            <div class="text-center text-muted py-5">
                <i class="bi bi-chat-text fs-1 mb-3 d-block"></i>
                <h6>Welcome to AI Assistant</h6>
                <p class="small mb-0">How can I help you today?</p>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="px-3 py-2 d-none border-top">
            <div class="d-flex align-items-center text-muted">
                <div class="typing-dots me-2">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <small>AI is typing</small>
            </div>
        </div>

        <!-- Input Area -->
        <div class="card-footer bg-white border-top p-3">
            <form id="chatbot-form">
                <div class="input-group">
                    <textarea 
                        id="chatbot-input" 
                        class="form-control border"
                        rows="1"
                        placeholder="Type your message..."
                        style="resize: none; max-height: 100px;"
                    ></textarea>
                    <button 
                        type="submit"
                        class="btn btn-primary px-3"
                        id="chatbot-send-btn"
                    >
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </form>
            
            <!-- Feedback Section -->
            <div id="feedback-section" class="mt-3 pt-3 border-top d-none">
                <div class="d-flex align-items-center justify-content-between">
                    <small class="text-muted">Was this helpful?</small>
                    <div class="btn-group btn-group-sm" role="group">
                        <button 
                            type="button" 
                            class="btn btn-outline-success" 
                            id="thumbs-up-btn"
                        >
                            <i class="bi bi-hand-thumbs-up"></i>
                        </button>
                        <button 
                            type="button" 
                            class="btn btn-outline-danger" 
                            id="thumbs-down-btn"
                        >
                            <i class="bi bi-hand-thumbs-down"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ============================================
   FLOATING BUTTON STYLES
   ============================================ */
.chatbot-float-btn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
    z-index: 1040;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
}

.chatbot-float-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(13, 110, 253, 0.5);
}

.chatbot-float-btn:active {
    transform: scale(0.95);
}

/* ============================================
   CHATBOT WINDOW STYLES
   ============================================ */
.chatbot-window {
    position: fixed;
    bottom: 100px;
    right: 24px;
    width: 400px;
    max-width: calc(100vw - 48px);
    height: 650px;
    max-height: calc(100vh - 150px);
    z-index: 1040;
    animation: slideUp 0.3s ease-out;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
}

.chatbot-window .card {
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.chatbot-window.minimized {
    height: 60px;
    overflow: hidden;
}

.chatbot-window.minimized .card-body,
.chatbot-window.minimized .card-footer,
.chatbot-window.minimized .quick-actions-container {
    display: none;
}

/* ============================================
   HEADER STYLES
   ============================================ */
.chatbot-window .card-header {
    border-radius: 16px 16px 0 0;
    padding: 16px;
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    cursor: pointer;
}

.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.chatbot-window .card-header h6 {
    font-size: 15px;
    line-height: 1.2;
}

.chatbot-window .card-header small {
    font-size: 11px;
    opacity: 0.9;
}

/* ============================================
   QUICK ACTIONS STYLES
   ============================================ */
.quick-actions-container {
    scrollbar-width: thin;
}

.quick-actions-container::-webkit-scrollbar {
    height: 4px;
}

.quick-actions-container::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 2px;
}

.quick-actions-container .btn {
    white-space: nowrap;
    font-size: 13px;
    transition: all 0.2s ease;
}

.quick-actions-container .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* ============================================
   MESSAGES CONTAINER STYLES
   ============================================ */
.messages-container {
    background: #f8f9fa;
    min-height: 300px;
    padding: 16px;
}

.messages-container::-webkit-scrollbar {
    width: 6px;
}

.messages-container::-webkit-scrollbar-track {
    background: transparent;
}

.messages-container::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.3);
}

/* ============================================
   MESSAGE BUBBLE STYLES
   ============================================ */
.message-item {
    margin-bottom: 16px;
    animation: messageSlide 0.3s ease-out;
}

@keyframes messageSlide {
    from {
        opacity: 0;
        transform: translateY(8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-bubble {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    line-height: 1.5;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    position: relative;
}

.message-user .message-bubble {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    color: white;
    border-bottom-right-radius: 6px;
    margin-left: auto;
}

.message-ai .message-bubble {
    background: white;
    color: #212529;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 6px;
    margin-right: auto;
}

.message-crisis .message-bubble {
    background: #fff5f5;
    border: 2px solid #dc3545;
    color: #721c24;
}

.message-bubble p {
    margin: 0;
    font-size: 14px;
}

.message-time {
    font-size: 11px;
    margin-top: 6px;
    opacity: 0.7;
    display: block;
}

.message-user .message-time {
    text-align: right;
    color: rgba(255, 255, 255, 0.9);
}

.message-ai .message-time {
    color: #6c757d;
}

/* ============================================
   TYPING INDICATOR STYLES
   ============================================ */
.typing-dots {
    display: flex;
    gap: 4px;
    align-items: center;
}

.typing-dots span {
    width: 8px;
    height: 8px;
    background: #6c757d;
    border-radius: 50%;
    animation: typingBounce 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) {
    animation-delay: 0s;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typingBounce {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-8px);
    }
}

/* ============================================
   INPUT AREA STYLES
   ============================================ */
.chatbot-window .card-footer {
    border-radius: 0 0 16px 16px;
    padding: 16px;
    background: #fff;
}

.chatbot-window textarea {
    border-radius: 20px;
    padding: 10px 16px;
    font-size: 14px;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

.chatbot-window textarea:focus {
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    border-color: #0d6efd;
}

.chatbot-window .input-group button {
    border-radius: 20px;
    margin-left: 8px;
    padding: 0 20px;
    transition: all 0.2s ease;
}

.chatbot-window .input-group button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
}

/* ============================================
   MOBILE RESPONSIVE
   ============================================ */
@media (max-width: 576px) {
    .chatbot-window {
        bottom: 90px;
        right: 12px;
        left: 12px;
        width: auto;
        max-width: none;
        height: calc(100vh - 120px);
    }
    
    .chatbot-float-btn {
        bottom: 16px;
        right: 16px;
        width: 56px;
        height: 56px;
    }
    
    .message-bubble {
        max-width: 90%;
    }
    
    .quick-actions-container .btn {
        font-size: 12px;
    }
}

/* ============================================
   UTILITY CLASSES
   ============================================ */
.fw-semibold {
    font-weight: 600;
}

/* Bootstrap Icons mapping for quick actions */
.bi-calendar3::before { content: "\f64b"; }
.bi-graph-up::before { content: "\f4fd"; }
.bi-currency-dollar::before { content: "\f636"; }
.bi-pencil-square::before { content: "\f5de"; }
.bi-heart-pulse::before { content: "\f4f8"; }
</style>

<script>
(function() {
    'use strict';
    
    // ============================================
    // STATE MANAGEMENT
    // ============================================
    let currentConversationId = null;
    let lastAiMessageId = null;
    let isProcessing = false;
    let isMinimized = false;
    
    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        initializeEventListeners();
    });
    
    function initializeEventListeners() {
        // Toggle button
        const toggleBtn = document.getElementById('chatbot-toggle-btn');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', toggleChatbot);
        }
        
        // Minimize button
        const minimizeBtn = document.getElementById('minimize-btn');
        if (minimizeBtn) {
            minimizeBtn.addEventListener('click', minimizeChatbot);
        }
        
        // Close button
        const closeBtn = document.getElementById('close-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', closeChatbot);
        }
        
        // New conversation button
        const newConvBtn = document.getElementById('new-conversation-btn');
        if (newConvBtn) {
            newConvBtn.addEventListener('click', newChatbotConversation);
        }
        
        // Quick action buttons
        const quickActionBtns = document.querySelectorAll('.quick-action-btn');
        quickActionBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                sendQuickAction(this.dataset.action);
            });
        });
        
        // Form submission
        const chatbotForm = document.getElementById('chatbot-form');
        if (chatbotForm) {
            chatbotForm.addEventListener('submit', sendChatMessage);
        }
        
        // Input keydown
        const chatbotInput = document.getElementById('chatbot-input');
        if (chatbotInput) {
            chatbotInput.addEventListener('keydown', handleInputKeydown);
        }
        
        // Rating buttons
        const thumbsUpBtn = document.getElementById('thumbs-up-btn');
        if (thumbsUpBtn) {
            thumbsUpBtn.addEventListener('click', function() {
                rateLastMessage(true);
            });
        }
        
        const thumbsDownBtn = document.getElementById('thumbs-down-btn');
        if (thumbsDownBtn) {
            thumbsDownBtn.addEventListener('click', function() {
                rateLastMessage(false);
            });
        }
        
        // Header click to maximize when minimized
        const chatHeader = document.querySelector('.chatbot-window .card-header');
        if (chatHeader) {
            chatHeader.addEventListener('click', function() {
                if (isMinimized) {
                    maximizeChatbot();
                }
            });
        }
    }
    
    // ============================================
    // WINDOW TOGGLE FUNCTIONS
    // ============================================
    function toggleChatbot() {
        const chatWindow = document.getElementById('chatbot-window');
        const toggleBtn = document.getElementById('chatbot-toggle-btn');
        
        if (chatWindow.classList.contains('d-none')) {
            // Open chatbot
            chatWindow.classList.remove('d-none');
            toggleBtn.classList.add('d-none');
            isMinimized = false;
            
            if (!currentConversationId) {
                loadOrCreateConversation();
            }
            
            setTimeout(() => {
                const input = document.getElementById('chatbot-input');
                if (input) input.focus();
            }, 100);
        } else {
            // Close chatbot
            closeChatbot();
        }
    }
    
    function minimizeChatbot() {
        const chatWindow = document.getElementById('chatbot-window');
        chatWindow.classList.add('minimized');
        isMinimized = true;
    }
    
    function maximizeChatbot() {
        const chatWindow = document.getElementById('chatbot-window');
        chatWindow.classList.remove('minimized');
        isMinimized = false;
        
        setTimeout(() => {
            const input = document.getElementById('chatbot-input');
            if (input) input.focus();
        }, 100);
    }
    
    function closeChatbot() {
        const chatWindow = document.getElementById('chatbot-window');
        const toggleBtn = document.getElementById('chatbot-toggle-btn');
        
        chatWindow.classList.add('d-none');
        chatWindow.classList.remove('minimized');
        toggleBtn.classList.remove('d-none');
        isMinimized = false;
    }
    
    // ============================================
    // CONVERSATION MANAGEMENT
    // ============================================
    async function loadOrCreateConversation() {
        try {
            const response = await fetch('/chatbot/conversations/', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });
            
            const data = await response.json();
            
            if (data.success && data.conversations && data.conversations.length > 0) {
                const activeConv = data.conversations.find(c => c.status === 'ACTIVE');
                if (activeConv) {
                    currentConversationId = activeConv.id;
                    await loadConversationMessages(activeConv.id);
                    return;
                }
            }
            
            await newChatbotConversation();
        } catch (error) {
            console.error('Error loading conversation:', error);
            showErrorMessage('Failed to load conversation. Please try again.');
        }
    }
    
    async function newChatbotConversation() {
        try {
            const response = await fetch('/chatbot/new-conversation/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                currentConversationId = data.conversation_id;
                clearMessages();
                
                if (data.welcome_message) {
                    addMessage('AI', data.welcome_message.content, data.welcome_message.timestamp);
                }
            } else {
                showErrorMessage(data.error || 'Failed to create conversation');
            }
        } catch (error) {
            console.error('Error creating conversation:', error);
            showErrorMessage('Failed to start conversation. Please try again.');
        }
    }
    
    async function loadConversationMessages(conversationId) {
        try {
            const response = await fetch(`/chatbot/conversation/${conversationId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });
            
            const data = await response.json();
            
            if (data.success && data.conversation) {
                clearMessages();
                
                if (data.conversation.messages && data.conversation.messages.length > 0) {
                    data.conversation.messages.forEach(msg => {
                        addMessage(
                            msg.type, 
                            msg.content, 
                            msg.timestamp, 
                            msg.id, 
                            msg.is_crisis
                        );
                    });
                }
                
                scrollToBottom();
            }
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }
    
    // ============================================
    // MESSAGE SENDING
    // ============================================
    async function sendChatMessage(event) {
        event.preventDefault();
        
        if (isProcessing) return;
        
        const input = document.getElementById('chatbot-input');
        const sendBtn = document.getElementById('chatbot-send-btn');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Lock UI
        isProcessing = true;
        input.disabled = true;
        sendBtn.disabled = true;
        
        // Add user message
        addMessage('USER', message, new Date().toISOString());
        input.value = '';
        
        // Show typing indicator
        showTypingIndicator();
        
        try {
            const response = await fetch('/chatbot/send-message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: currentConversationId
                })
            });
            
            const data = await response.json();
            
            hideTypingIndicator();
            
            if (data.success) {
                currentConversationId = data.conversation_id;
                
                if (data.ai_message) {
                    addMessage(
                        'AI', 
                        data.ai_message.content, 
                        data.ai_message.timestamp, 
                        data.ai_message.id, 
                        data.is_crisis
                    );
                    lastAiMessageId = data.ai_message.id;
                    
                    // Show feedback section
                    const feedbackSection = document.getElementById('feedback-section');
                    if (feedbackSection) {
                        feedbackSection.classList.remove('d-none');
                    }
                }
                
                if (data.is_crisis && data.crisis_resources) {
                    showCrisisResources(data.crisis_resources);
                }
            } else {
                showErrorMessage(data.error || 'Failed to send message');
            }
        } catch (error) {
            hideTypingIndicator();
            console.error('Error sending message:', error);
            showErrorMessage('Failed to send message. Please try again.');
        } finally {
            // Unlock UI
            isProcessing = false;
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }
    }
    
    // ============================================
    // MESSAGE DISPLAY
    // ============================================
    function addMessage(type, content, timestamp, messageId = null, isCrisis = false) {
        const container = document.getElementById('chatbot-messages');
        if (!container) return;
        
        // Remove welcome message if it exists
        const welcomeMsg = container.querySelector('.text-center.text-muted');
        if (welcomeMsg) {
            welcomeMsg.remove();
        }
        
        const messageItem = document.createElement('div');
        messageItem.className = `message-item message-${type.toLowerCase()}`;
        
        if (messageId) {
            messageItem.dataset.messageId = messageId;
        }
        
        let bubbleClass = 'message-bubble';
        if (isCrisis) bubbleClass += ' message-crisis';
        
        if (type === 'USER') {
            messageItem.innerHTML = `
                <div class="d-flex justify-content-end">
                    <div class="${bubbleClass}">
                        <p>${escapeHtml(content)}</p>
                        <span class="message-time">${formatTime(timestamp)}</span>
                    </div>
                </div>
            `;
        } else {
            messageItem.innerHTML = `
                <div class="d-flex justify-content-start">
                    <div class="${bubbleClass}">
                        ${isCrisis ? '<div class="mb-2"><i class="bi bi-exclamation-triangle-fill text-danger"></i> <strong>Important</strong></div>' : ''}
                        <p>${formatMessageContent(content)}</p>
                        <span class="message-time">${formatTime(timestamp)}</span>
                    </div>
                </div>
            `;
        }
        
        container.appendChild(messageItem);
        scrollToBottom();
    }
    
    function clearMessages() {
        const container = document.getElementById('chatbot-messages');
        if (container) {
            container.innerHTML = '';
        }
    }
    
    // ============================================
    // QUICK ACTIONS
    // ============================================
    function sendQuickAction(action) {
        const messages = {
            'timetable': 'Show me my timetable',
            'grades': 'What are my current grades?',
            'fees': 'What is my fee balance?',
            'registration': 'Help me with registration',
            'mental_health': 'I need someone to talk to'
        };
        
        const input = document.getElementById('chatbot-input');
        if (input && messages[action]) {
            input.value = messages[action];
            input.focus();
        }
    }
    
    // ============================================
    // MESSAGE RATING
    // ============================================
    async function rateLastMessage(wasHelpful) {
        if (!lastAiMessageId) return;
        
        try {
            await fetch('/chatbot/rate-message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({
                    message_id: lastAiMessageId,
                    was_helpful: wasHelpful
                })
            });
            
            const feedbackSection = document.getElementById('feedback-section');
            if (feedbackSection) {
                feedbackSection.classList.add('d-none');
            }
            
            showTempMessage(
                wasHelpful 
                    ? '<i class="bi bi-check-circle-fill text-success"></i> Thank you for your feedback!' 
                    : '<i class="bi bi-info-circle-fill text-primary"></i> Thank you! We\'ll improve.'
            );
        } catch (error) {
            console.error('Error rating message:', error);
        }
    }
    
    // ============================================
    // UI HELPERS
    // ============================================
    function showTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.classList.remove('d-none');
            scrollToBottom();
        }
    }
    
    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.classList.add('d-none');
        }
    }
    
    function scrollToBottom() {
        const container = document.getElementById('chatbot-messages');
        if (container) {
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
    }
    
    function showErrorMessage(message) {
        addMessage('SYSTEM', `<i class="bi bi-exclamation-circle-fill text-danger"></i> ${message}`, new Date().toISOString());
    }
    
    function showTempMessage(html) {
        const container = document.getElementById('chatbot-messages');
        if (!container) return;
        
        const tempDiv = document.createElement('div');
        tempDiv.className = 'text-center text-muted py-2 small';
        tempDiv.innerHTML = html;
        container.appendChild(tempDiv);
        
        setTimeout(() => tempDiv.remove(), 3000);
    }
    
    function showCrisisResources(resources) {
        if (!resources || !resources.emergency_numbers) return;
        
        let html = '<div class="mb-2"><i class="bi bi-telephone-fill text-danger"></i> <strong>Emergency Resources:</strong></div>';
        
        resources.emergency_numbers.forEach(resource => {
            html += `<div class="mb-1"><i class="bi bi-dot"></i> ${resource.name}: <strong>${resource.number}</strong></div>`;
        });
        
        addMessage('SYSTEM', html, new Date().toISOString(), null, true);
    }
    
    // ============================================
    // INPUT HANDLING
    // ============================================
    function handleInputKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendChatMessage(event);
        }
    }
    
    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        
        return date.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatMessageContent(content) {
        // Convert URLs to links
        content = content.replace(
            /(https?:\/\/[^\s]+)/g, 
            '<a href="$1" target="_blank" class="text-primary text-decoration-underline">$1</a>'
        );
        
        // Convert line breaks
        content = content.replace(/\n/g, '<br>');
        
        return content;
    }
    
    function getCsrfToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        return token ? token.value : '';
    }
    
    // Make functions globally available
    window.toggleChatbot = toggleChatbot;
    window.minimizeChatbot = minimizeChatbot;
    window.newChatbotConversation = newChatbotConversation;
    window.sendQuickAction = sendQuickAction;
    window.rateLastMessage = rateLastMessage;
    window.handleInputKeydown = handleInputKeydown;
})();
</script>