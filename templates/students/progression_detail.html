{% extends 'admin_base.html' %}

{% block title %}{{ student.registration_number }} - Progression Detail{% endblock %}

{% block page_title %}Student Progression Detail{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
    .breadcrumb {
        padding: 0;
        margin-bottom: 20px;
        font-size: 14px;
        list-style: none;
        display: flex;
        flex-wrap: wrap;
    }

    .breadcrumb-item {
        color: #64748B;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "/ ";
        color: #94A3B8;
        padding: 0 8px;
    }

    .breadcrumb-item.active {
        color: #1E293B;
        font-weight: 500;
    }

    .breadcrumb a {
        color: #4F46E5;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        color: #4338CA;
    }

    .student-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: start;
        gap: 20px;
        flex-wrap: wrap;
    }

    .student-info h2 {
        margin: 0 0 10px 0;
        font-size: 28px;
    }

    .student-meta {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        font-size: 14px;
        opacity: 0.95;
        margin-top: 10px;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .classification-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        min-width: 200px;
    }

    .classification-label {
        font-size: 13px;
        opacity: 0.9;
        margin-bottom: 5px;
    }

    .classification-value {
        font-size: 36px;
        font-weight: 700;
        display: block;
        margin-bottom: 5px;
    }

    .classification-text {
        font-size: 14px;
        font-weight: 600;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        margin-bottom: 15px;
    }

    .stat-icon.purple {
        background: #EDE9FE;
        color: #7C3AED;
    }

    .stat-icon.green {
        background: #D1FAE5;
        color: #059669;
    }

    .stat-icon.yellow {
        background: #FEF3C7;
        color: #D97706;
    }

    .stat-icon.red {
        background: #FEE2E2;
        color: #DC2626;
    }

    .stat-label {
        font-size: 13px;
        color: #64748B;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #1E293B;
    }

    .year-tabs {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
        margin-bottom: 30px;
    }

    .tabs-header {
        display: flex;
        border-bottom: 2px solid #F1F5F9;
        overflow-x: auto;
    }

    .tab-button {
        padding: 15px 25px;
        border: none;
        background: none;
        font-size: 14px;
        font-weight: 600;
        color: #64748B;
        cursor: pointer;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
        white-space: nowrap;
    }

    .tab-button:hover {
        color: #4F46E5;
    }

    .tab-button.active {
        color: #4F46E5;
        border-bottom-color: #4F46E5;
    }

    .tab-content {
        display: none;
        padding: 20px;
    }

    .tab-content.active {
        display: block;
    }

    .semester-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .semester-tab {
        padding: 10px 20px;
        border: 2px solid #E2E8F0;
        background: white;
        border-radius: 5px;
        font-size: 13px;
        font-weight: 600;
        color: #64748B;
        cursor: pointer;
        transition: all 0.3s;
    }

    .semester-tab:hover {
        border-color: #4F46E5;
        color: #4F46E5;
    }

    .semester-tab.active {
        background: #4F46E5;
        color: white;
        border-color: #4F46E5;
    }

    .semester-content {
        display: none;
    }

    .semester-content.active {
        display: block;
    }

    .semester-summary {
        background: #F8FAFC;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .summary-item {
        display: flex;
        flex-direction: column;
    }

    .summary-label {
        font-size: 12px;
        color: #64748B;
        margin-bottom: 3px;
    }

    .summary-value {
        font-size: 18px;
        font-weight: 700;
        color: #1E293B;
    }

    .units-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        margin-bottom: 20px;
    }

    .units-table thead {
        background: #F8FAFC;
    }

    .units-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #475569;
        border-bottom: 2px solid #E2E8F0;
    }

    .units-table td {
        padding: 12px;
        border-bottom: 1px solid #F1F5F9;
        color: #1E293B;
    }

    .units-table tbody tr:hover {
        background: #F8FAFC;
    }

    .marks-breakdown {
        font-size: 12px;
        color: #64748B;
    }

    .marks-item {
        margin-bottom: 3px;
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-A {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .badge-B {
        background: #D1FAE5;
        color: #065F46;
    }

    .badge-C {
        background: #FEF3C7;
        color: #92400E;
    }

    .badge-D {
        background: #FED7AA;
        color: #9A3412;
    }

    .badge-F {
        background: #FEE2E2;
        color: #991B1B;
    }

    .grade-display {
        font-size: 18px;
        font-weight: 700;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
    }

    .btn-secondary {
        background: #64748B;
        color: white;
    }

    .btn-secondary:hover {
        background: #475569;
    }

    .action-bar {
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .header-content {
            flex-direction: column;
        }

        .classification-card {
            width: 100%;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .tabs-header {
            flex-wrap: wrap;
        }

        .units-table {
            font-size: 12px;
        }

        .units-table th,
        .units-table td {
            padding: 8px;
        }
    }

    @media print {
        .action-bar,
        .breadcrumb,
        .btn {
            display: none !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class="bi bi-house-door"></i> Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'student_progression_list' %}">Student Progression</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ student.registration_number }}</li>
    </ol>
</nav>

<!-- Action Bar -->
<div class="action-bar">
    <a href="{% url 'student_progression_list' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to List
    </a>
</div>

<!-- Student Header -->
<div class="student-header">
    <div class="header-content">
        <div class="student-info">
            <h2>{{ student.first_name }} {{ student.last_name }} {{ student.surname }}</h2>
            <div class="student-meta">
                <span class="meta-item">
                    <i class="bi bi-hash"></i>
                    {{ student.registration_number }}
                </span>
                <span class="meta-item">
                    <i class="bi bi-book"></i>
                    {{ student.programme.code }} - {{ student.programme.name }}
                </span>
                <span class="meta-item">
                    <i class="bi bi-calendar"></i>
                    Year {{ student.current_year }}
                </span>
            </div>
        </div>
        <div class="classification-card">
            <div class="classification-label">Overall GPA</div>
            <span class="classification-value">{{ overall_gpa|floatformat:2 }}</span>
            <div class="classification-text">{{ classification }}</div>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon purple">
            <i class="bi bi-journal-text"></i>
        </div>
        <div class="stat-label">Total Enrollments</div>
        <div class="stat-value">{{ total_enrollments }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green">
            <i class="bi bi-check-circle"></i>
        </div>
        <div class="stat-label">Completed Units</div>
        <div class="stat-value">{{ completed_units }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon yellow">
            <i class="bi bi-award"></i>
        </div>
        <div class="stat-label">Total Credits</div>
        <div class="stat-value">{{ total_credits }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon red">
            <i class="bi bi-x-circle"></i>
        </div>
        <div class="stat-label">Failed Units</div>
        <div class="stat-value">{{ failed_units }}</div>
    </div>
</div>

<!-- Academic Year Tabs -->
<div class="year-tabs">
    <div class="tabs-header" id="yearTabsHeader">
        {% for year_key, year_data in academic_data.items %}
        <button class="tab-button {% if forloop.first %}active{% endif %}" 
                onclick="showYearTab('year{{ forloop.counter }}')">
            {{ year_data.year.year_code }}
            <div style="font-size: 11px; opacity: 0.8; margin-top: 3px;">
                GPA: {{ year_data.year_gpa|floatformat:2 }}
            </div>
        </button>
        {% endfor %}
    </div>

    {% for year_key, year_data in academic_data.items %}
    <div id="year{{ forloop.counter }}" class="tab-content {% if forloop.first %}active{% endif %}">
        <!-- Year Summary -->
        <div class="semester-summary">
            <div class="summary-item">
                <span class="summary-label">Academic Year</span>
                <span class="summary-value">{{ year_data.year.year_code }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Year GPA</span>
                <span class="summary-value">{{ year_data.year_gpa|floatformat:2 }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Total Credits</span>
                <span class="summary-value">{{ year_data.total_credits }}</span>
            </div>
        </div>

        <!-- Semester Tabs -->
        <div class="semester-tabs" id="semesterTabs{{ forloop.counter }}">
            {% for semester_key, semester_data in year_data.semesters.items %}
            <button class="semester-tab {% if forloop.first %}active{% endif %}" 
                    onclick="showSemesterTab('year{{ forloop.parentloop.counter }}', 'semester{{ forloop.counter }}')">
                Semester {{ semester_data.semester.semester_number }}
                <div style="font-size: 10px; margin-top: 2px;">
                    GPA: {{ semester_data.semester_gpa|floatformat:2 }}
                </div>
            </button>
            {% endfor %}
        </div>

        <!-- Semester Content -->
        {% for semester_key, semester_data in year_data.semesters.items %}
        <div id="year{{ forloop.parentloop.counter }}_semester{{ forloop.counter }}" 
             class="semester-content {% if forloop.first %}active{% endif %}">
            
            <div class="semester-summary" style="margin-top: 15px;">
                <div class="summary-item">
                    <span class="summary-label">Semester</span>
                    <span class="summary-value">{{ semester_data.semester }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Semester GPA</span>
                    <span class="summary-value">{{ semester_data.semester_gpa|floatformat:2 }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Credits</span>
                    <span class="summary-value">{{ semester_data.total_credits }}</span>
                </div>
            </div>

            <!-- Units Table -->
            <table class="units-table">
                <thead>
                    <tr>
                        <th>Unit Code</th>
                        <th>Unit Name</th>
                        <th>Credits</th>
                        <th>Assessment Breakdown</th>
                        <th>Total</th>
                        <th>Grade</th>
                        <th>GP</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in semester_data.results %}
                    <tr>
                        <td><strong>{{ result.unit.code }}</strong></td>
                        <td>{{ result.unit.name }}</td>
                        <td>{{ result.credits }}</td>
                        <td>
                            <div class="marks-breakdown">
                                {% for mark in result.marks %}
                                <div class="marks-item">
                                    {{ mark.component }}: 
                                    <strong>{{ mark.marks|floatformat:1 }}/{{ mark.max_marks|floatformat:0 }}</strong>
                                    ({{ mark.weight }}%)
                                </div>
                                {% empty %}
                                <span style="color: #94A3B8;">No marks entered</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <strong style="font-size: 16px;">
                                {{ result.total_marks|floatformat:1 }}%
                            </strong>
                        </td>
                        <td>
                            <span class="grade-display badge badge-{{ result.grade }}">
                                {{ result.grade }}
                            </span>
                        </td>
                        <td>
                            <strong>{{ result.grade_point|floatformat:2 }}</strong>
                        </td>
                        <td>{{ result.status }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" style="text-align: center; color: #64748B; padding: 30px;">
                            No units enrolled for this semester
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    {% empty %}
    <div class="tab-content active">
        <div style="text-align: center; padding: 60px 20px; color: #64748B;">
            <i class="bi bi-inbox" style="font-size: 64px; opacity: 0.3; margin-bottom: 20px;"></i>
            <h3>No Academic Records Found</h3>
            <p>This student has no enrollment records yet.</p>
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Year tab switching
    function showYearTab(yearId) {
        // Hide all year tabs
        const yearTabs = document.querySelectorAll('.tab-content');
        yearTabs.forEach(tab => {
            tab.classList.remove('active');
        });

        // Remove active class from all year buttons
        const yearButtons = document.querySelectorAll('.tab-button');
        yearButtons.forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected year tab
        document.getElementById(yearId).classList.add('active');

        // Add active class to clicked button
        event.target.closest('.tab-button').classList.add('active');
    }

    // Semester tab switching
    function showSemesterTab(yearId, semesterId) {
        // Hide all semester contents in this year
        const semesterContents = document.querySelectorAll(`#${yearId} .semester-content`);
        semesterContents.forEach(content => {
            content.classList.remove('active');
        });

        // Remove active class from all semester buttons in this year
        const semesterButtons = document.querySelectorAll(`#${yearId} .semester-tab`);
        semesterButtons.forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected semester content
        document.getElementById(`${yearId}_${semesterId}`).classList.add('active');

        // Add active class to clicked button
        event.target.closest('.semester-tab').classList.add('active');
    }

    // Print functionality
    function printReport() {
        window.print();
    }

    console.log('Progression detail loaded');
</script>
{% endblock %}