{% extends 'admin_base.html' %}
{% load static %}
{% block title %}Analytics & Reports - Admin Dashboard{% endblock %}

{% block page_title %}Analytics & Reports{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<link rel='stylesheet' href='{% static 'css/reports.css' %}'>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class="bi bi-house-door"></i> Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Reports & Analytics</li>
    </ol>
</nav>

<!-- Page Header -->
<div class="page-header">
    <div class="header-info">
        <h1 style="font-size: 28px; font-weight: 700; color: #1E293B; margin: 0;">Reports & Analytics</h1>
        <p style="color: #64748B; margin: 4px 0 0 0;">
            {% if current_academic_year %}
            Academic Year: {{ current_academic_year.year_code }}
            {% endif %}
            {% if current_semester %}
            | Semester {{ current_semester.semester_number }}
            {% endif %}
        </p>
    </div>
    <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.print()">
            <i class="bi bi-printer"></i> Print Report
        </button>
        <button class="btn btn-primary" onclick="exportReport()">
            <i class="bi bi-download"></i> Export Data
        </button>
    </div>
</div>

<!-- Summary Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-content">
                <h3>Total Students</h3>
                <div class="stat-value">{{ total_students }}</div>
                <div class="stat-trend up">
                    <i class="bi bi-arrow-up"></i> Active students
                </div>
            </div>
            <div class="stat-icon blue">
                <i class="bi bi-people"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-content">
                <h3>Active Programmes</h3>
                <div class="stat-value">{{ total_programmes }}</div>
                <div class="stat-trend">
                    <i class="bi bi-mortarboard"></i> Running programmes
                </div>
            </div>
            <div class="stat-icon green">
                <i class="bi bi-book"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-content">
                <h3>Departments</h3>
                <div class="stat-value">{{ total_departments }}</div>
                <div class="stat-trend">
                    <i class="bi bi-building"></i> Total departments
                </div>
            </div>
            <div class="stat-icon purple">
                <i class="bi bi-diagram-3"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-content">
                <h3>Current Enrollments</h3>
                <div class="stat-value">{{ current_enrollments }}</div>
                <div class="stat-trend up">
                    <i class="bi bi-arrow-up"></i> This semester
                </div>
            </div>
            <div class="stat-icon orange">
                <i class="bi bi-journal-check"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-content">
                <h3>Completion Rate</h3>
                <div class="stat-value">{{ completion_rate }}%</div>
                <div class="stat-trend {% if completion_rate >= 70 %}up{% else %}down{% endif %}">
                    <i class="bi bi-{% if completion_rate >= 70 %}arrow-up{% else %}arrow-down{% endif %}"></i> 
                    Overall success rate
                </div>
            </div>
            <div class="stat-icon {% if completion_rate >= 70 %}green{% else %}red{% endif %}">
                <i class="bi bi-trophy"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Grid -->
<div class="charts-grid">
    <!-- Bar Chart - Student Enrollment by Programme -->
    <div class="chart-container">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-bar-chart"></i>
                    Students by Programme
                </div>
                <div class="chart-subtitle">Active student enrollment distribution</div>
            </div>
        </div>
        <div class="chart-canvas">
            <canvas id="programmeChart"></canvas>
        </div>
    </div>

    <!-- Pie Chart - Year Level Distribution -->
    <div class="chart-container">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-pie-chart"></i>
                    Year Level Distribution
                </div>
                <div class="chart-subtitle">Students by current year of study</div>
            </div>
        </div>
        <div class="chart-canvas">
            <canvas id="yearChart"></canvas>
        </div>
    </div>

    <!-- Line Chart - Enrollment Trends -->
    <div class="chart-container full-width">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-graph-up"></i>
                    Enrollment Trends
                </div>
                <div class="chart-subtitle">Unit enrollment trends over the last 6 months</div>
            </div>
            <div class="period-selector">
                <button class="period-btn active">6M</button>
                <button class="period-btn">1Y</button>
                <button class="period-btn">ALL</button>
            </div>
        </div>
        <div class="chart-canvas">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <!-- Donut Chart - Enrollment Status -->
    <div class="chart-container">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-activity"></i>
                    Enrollment Status
                </div>
                <div class="chart-subtitle">Current status of all enrollments</div>
            </div>
        </div>
        <div class="chart-canvas">
            <canvas id="statusChart"></canvas>
        </div>
    </div>

    <!-- Horizontal Bar Chart - Department Stats -->
    <div class="chart-container">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-building"></i>
                    Students by Department
                </div>
                <div class="chart-subtitle">Top 10 departments by student count</div>
            </div>
        </div>
        <div class="chart-canvas">
            <canvas id="departmentChart"></canvas>
        </div>
    </div>

    <!-- Pie Chart - Fee Payment Status -->
    {% if payment_labels %}
    <div class="chart-container">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-credit-card"></i>
                    Fee Payment Status
                </div>
                <div class="chart-subtitle">Current semester payment distribution</div>
            </div>
        </div>
        <div class="chart-canvas">
            <canvas id="paymentChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- Line Chart - Semester Registrations -->
    <div class="chart-container">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-calendar-check"></i>
                    Registration Trends
                </div>
                <div class="chart-subtitle">Student registrations by semester</div>
            </div>
        </div>
        <div class="chart-canvas">
            <canvas id="registrationChart"></canvas>
        </div>
    </div>

    <!-- Donut Chart - Programme Levels -->
    <div class="chart-container">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-mortarboard"></i>
                    Programme Levels
                </div>
                <div class="chart-subtitle">Distribution of programmes by level</div>
            </div>
        </div>
        <div class="chart-canvas">
            <canvas id="levelChart"></canvas>
        </div>
    </div>

    <!-- Line Chart - Revenue Trends -->
    {% if revenue_labels %}
    <div class="chart-container full-width">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-currency-dollar"></i>
                    Revenue Trends
                </div>
                <div class="chart-subtitle">Monthly fee collection for current academic year</div>
            </div>
        </div>
        <div class="chart-canvas">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- Pie Chart - Gender Distribution -->
    <div class="chart-container">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-gender-ambiguous"></i>
                    Gender Distribution
                </div>
                <div class="chart-subtitle">Student gender breakdown</div>
            </div>
        </div>
        <div class="chart-canvas">
            <canvas id="genderChart"></canvas>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // Chart.js Global Configuration
    Chart.defaults.font.family = "'Inter', system-ui, -apple-system, sans-serif";
    Chart.defaults.color = '#64748B';
    
    const chartColors = {
        primary: '#4F46E5',
        secondary: '#06B6D4',
        success: '#10B981',
        warning: '#F59E0B',
        danger: '#EF4444',
        purple: '#9333EA',
        pink: '#EC4899',
        indigo: '#6366F1',
        teal: '#14B8A6',
        orange: '#F97316'
    };

    const multiColors = [
        chartColors.primary,
        chartColors.secondary,
        chartColors.success,
        chartColors.warning,
        chartColors.danger,
        chartColors.purple,
        chartColors.pink,
        chartColors.indigo,
        chartColors.teal,
        chartColors.orange
    ];

    // 1. Bar Chart - Programme Enrollment
    const programmeCtx = document.getElementById('programmeChart').getContext('2d');
    new Chart(programmeCtx, {
        type: 'bar',
        data: {
            labels: {{ programme_labels|safe }},
            datasets: [{
                label: 'Students',
                data: {{ programme_data|safe }},
                backgroundColor: chartColors.primary,
                borderRadius: 6,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#F1F5F9'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // 2. Pie Chart - Year Distribution
    const yearCtx = document.getElementById('yearChart').getContext('2d');
    new Chart(yearCtx, {
        type: 'pie',
        data: {
            labels: {{ year_labels|safe }},
            datasets: [{
                data: {{ year_data|safe }},
                backgroundColor: [
                    chartColors.primary,
                    chartColors.secondary,
                    chartColors.success,
                    chartColors.warning
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + value + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // 3. Line Chart - Enrollment Trends
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: {{ trend_labels|safe }},
            datasets: [{
                label: 'Enrollments',
                data: {{ trend_data|safe }},
                borderColor: chartColors.primary,
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: chartColors.primary,
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#F1F5F9'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // 4. Donut Chart - Enrollment Status
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: {{ status_labels|safe }},
            datasets: [{
                data: {{ status_data|safe }},
                backgroundColor: [
                    chartColors.success,
                    chartColors.warning,
                    chartColors.primary,
                    chartColors.danger
                ],
                borderWidth: 0,
                cutout: '65%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            }
        }
    });

    // 5. Horizontal Bar Chart - Department Stats
    const deptCtx = document.getElementById('departmentChart').getContext('2d');
    new Chart(deptCtx, {
        type: 'bar',
        data: {
            labels: {{ dept_labels|safe }},
            datasets: [{
                label: 'Students',
                data: {{ dept_data|safe }},
                backgroundColor: chartColors.secondary,
                borderRadius: 6,
                borderWidth: 0
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: '#F1F5F9'
                    }
                },
                y: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // 6. Pie Chart - Fee Payment Status
    {% if payment_labels %}
    const paymentCtx = document.getElementById('paymentChart').getContext('2d');
    new Chart(paymentCtx, {
        type: 'pie',
        data: {
            labels: {{ payment_labels|safe }},
            datasets: [{
                data: {{ payment_data|safe }},
                backgroundColor: [
                    chartColors.warning,
                    chartColors.primary,
                    chartColors.success,
                    chartColors.danger
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            }
        }
    });
    {% endif %}

    // 7. Line Chart - Semester Registrations
    const regCtx = document.getElementById('registrationChart').getContext('2d');
    new Chart(regCtx, {
        type: 'line',
        data: {
            labels: {{ semester_labels|safe }},
            datasets: [{
                label: 'Registrations',
                data: {{ semester_registrations|safe }},
                borderColor: chartColors.success,
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: chartColors.success,
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#F1F5F9'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // 8. Donut Chart - Programme Levels
    const levelCtx = document.getElementById('levelChart').getContext('2d');
    new Chart(levelCtx, {
        type: 'doughnut',
        data: {
            labels: {{ level_labels|safe }},
            datasets: [{
                data: {{ level_data|safe }},
                backgroundColor: multiColors,
                borderWidth: 0,
                cutout: '65%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            }
        }
    });

    // 9. Line Chart - Revenue Trends
    {% if revenue_labels %}
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: {{ revenue_labels|safe }},
            datasets: [{
                label: 'Revenue (KES)',
                data: {{ revenue_data|safe }},
                borderColor: chartColors.success,
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: chartColors.success,
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += 'KES ' + context.parsed.y.toLocaleString();
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#F1F5F9'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'KES ' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    {% endif %}

    // 10. Pie Chart - Gender Distribution
    const genderCtx = document.getElementById('genderChart').getContext('2d');
    new Chart(genderCtx, {
        type: 'pie',
        data: {
            labels: {{ gender_labels|safe }},
            datasets: [{
                data: {{ gender_data|safe }},
                backgroundColor: [
                    chartColors.primary,
                    chartColors.pink
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            return label + ': ' + value + '%';
                        }
                    }
                }
            }
        }
    });

    // Period Selector Functionality
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            // Here you would typically reload the chart with new data
            console.log('Period changed to:', this.textContent);
        });
    });

    // Export Report Function
    function exportReport() {
        alert('Export functionality would be implemented here.\nOptions: PDF, Excel, CSV');
        // You would implement actual export logic here
    }

    // Print Optimization
    window.addEventListener('beforeprint', function() {
        // Adjust charts for print if needed
        console.log('Preparing for print...');
    });

    // Animation on scroll (optional enhancement)
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    document.querySelectorAll('.chart-container, .stat-card').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        observer.observe(el);
    });
</script>
{% endblock %}
