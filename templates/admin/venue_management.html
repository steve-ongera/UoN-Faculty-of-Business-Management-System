{% extends 'admin_base.html' %}
{% load static %}

{% block title %}Venue Management - Admin Dashboard{% endblock %}

{% block page_title %}Venue Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
    .breadcrumb {
        padding: 0;
        margin-bottom: 20px;
        font-size: 14px;
        list-style: none;
        display: flex;
        flex-wrap: wrap;
    }

    .breadcrumb-item {
        color: #64748B;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "/ ";
        color: #94A3B8;
        padding: 0 8px;
    }

    .breadcrumb-item.active {
        color: #1E293B;
        font-weight: 500;
    }

    .breadcrumb a {
        color: #4F46E5;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .breadcrumb a:hover {
        color: #4338CA;
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid #E2E8F0;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .stat-icon.total {
        background: #EEF2FF;
        color: #4F46E5;
    }

    .stat-icon.available {
        background: #D1FAE5;
        color: #10B981;
    }

    .stat-icon.halls {
        background: #FEF3C7;
        color: #F59E0B;
    }

    .stat-icon.labs {
        background: #FCE7F3;
        color: #EC4899;
    }

    .stat-icon.projector {
        background: #E0E7FF;
        color: #6366F1;
    }

    .stat-icon.computers {
        background: #DBEAFE;
        color: #3B82F6;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #1E293B;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 13px;
        color: #64748B;
        font-weight: 500;
    }

    /* Main Container */
    .section-container {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        border: 1px solid #E2E8F0;
    }

    /* Toolbar */
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        gap: 16px;
        flex-wrap: wrap;
    }

    .toolbar-left {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-box {
        position: relative;
        min-width: 300px;
    }

    .search-box input {
        width: 100%;
        padding: 10px 40px 10px 38px;
        border: 1px solid #E2E8F0;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .search-box input:focus {
        outline: none;
        border-color: #4F46E5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #94A3B8;
        font-size: 16px;
    }

    .clear-search {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #94A3B8;
        cursor: pointer;
        padding: 4px;
        display: none;
    }

    .clear-search:hover {
        color: #64748B;
    }

    .filter-select {
        padding: 10px 14px;
        border: 1px solid #E2E8F0;
        border-radius: 6px;
        font-size: 14px;
        color: #64748B;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 150px;
    }

    .filter-select:focus {
        outline: none;
        border-color: #4F46E5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .toolbar-right {
        display: flex;
        gap: 10px;
    }

    .btn {
        padding: 10px 18px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .btn-primary {
        background: #4F46E5;
        color: white;
    }

    .btn-primary:hover {
        background: #4338CA;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: #F8FAFC;
        color: #64748B;
        border: 1px solid #E2E8F0;
    }

    .btn-secondary:hover {
        background: #F1F5F9;
        color: #475569;
    }

    .btn-success {
        background: #10B981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
        transform: translateY(-1px);
    }

    /* Table */
    .table-container {
        overflow-x: auto;
        margin-bottom: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: #F8FAFC;
        border-bottom: 2px solid #E2E8F0;
    }

    th {
        padding: 14px 12px;
        text-align: left;
        font-size: 13px;
        font-weight: 700;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    td {
        padding: 14px 12px;
        border-bottom: 1px solid #F1F5F9;
        font-size: 14px;
        color: #475569;
    }

    tbody tr {
        transition: background 0.2s ease;
    }

    tbody tr:hover {
        background: #FAFAFA;
    }

    .venue-code {
        font-weight: 700;
        color: #4F46E5;
    }

    .venue-name {
        color: #1E293B;
        font-weight: 500;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .badge.available {
        background: #D1FAE5;
        color: #065F46;
    }

    .badge.unavailable {
        background: #FEE2E2;
        color: #991B1B;
    }

    .badge.lecture-hall {
        background: #FEF3C7;
        color: #92400E;
    }

    .badge.tutorial-room {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .badge.lab {
        background: #FCE7F3;
        color: #9F1239;
    }

    .badge.seminar-room {
        background: #E0E7FF;
        color: #3730A3;
    }

    .feature-icons {
        display: flex;
        gap: 8px;
    }

    .feature-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }

    .feature-icon.active {
        background: #D1FAE5;
        color: #065F46;
    }

    .feature-icon.inactive {
        background: #F1F5F9;
        color: #CBD5E1;
    }

    .action-buttons {
        display: flex;
        gap: 6px;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
    }

    .action-btn.view {
        background: #EEF2FF;
        color: #4F46E5;
    }

    .action-btn.view:hover {
        background: #E0E7FF;
    }

    .action-btn.edit {
        background: #FEF3C7;
        color: #F59E0B;
    }

    .action-btn.edit:hover {
        background: #FDE68A;
    }

    .action-btn.delete {
        background: #FEE2E2;
        color: #DC2626;
    }

    .action-btn.delete:hover {
        background: #FECACA;
    }

    .action-btn.toggle {
        background: #D1FAE5;
        color: #10B981;
    }

    .action-btn.toggle:hover {
        background: #A7F3D0;
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #E2E8F0;
    }

    .pagination-info {
        font-size: 14px;
        color: #64748B;
    }

    .pagination-controls {
        display: flex;
        gap: 8px;
    }

    .pagination-btn {
        padding: 8px 14px;
        border: 1px solid #E2E8F0;
        border-radius: 6px;
        background: white;
        color: #64748B;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .pagination-btn:hover:not(:disabled) {
        background: #F8FAFC;
        border-color: #CBD5E1;
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-btn.active {
        background: #4F46E5;
        color: white;
        border-color: #4F46E5;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(2px);
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 2px solid #E2E8F0;
        background: #F8FAFC;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 700;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .modal-close {
        background: white;
        border: 1px solid #E2E8F0;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 18px;
        color: #64748B;
    }

    .modal-close:hover {
        background: #F1F5F9;
        color: #1E293B;
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 8px;
    }

    .form-label.required::after {
        content: " *";
        color: #DC2626;
    }

    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #E2E8F0;
        border-radius: 6px;
        font-size: 14px;
        color: #1E293B;
        transition: all 0.3s ease;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: #4F46E5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-textarea {
        resize: vertical;
        min-height: 80px;
    }

    .form-checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
    }

    .form-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .form-checkbox-label {
        font-size: 14px;
        color: #475569;
        cursor: pointer;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .form-error {
        color: #DC2626;
        font-size: 12px;
        margin-top: 6px;
        display: none;
    }

    .form-error.active {
        display: block;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #E2E8F0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        background: #F8FAFC;
    }

    /* Detail View Modal */
    .detail-section {
        margin-bottom: 24px;
    }

    .detail-section:last-child {
        margin-bottom: 0;
    }

    .detail-section-title {
        font-size: 16px;
        font-weight: 700;
        color: #1E293B;
        margin-bottom: 14px;
        padding-bottom: 8px;
        border-bottom: 2px solid #E2E8F0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .detail-item {
        background: #F8FAFC;
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #4F46E5;
    }

    .detail-label {
        font-size: 12px;
        font-weight: 600;
        color: #64748B;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .detail-value {
        font-size: 15px;
        font-weight: 600;
        color: #1E293B;
    }

    .timetable-list {
        margin-top: 12px;
    }

    .timetable-day {
        margin-bottom: 16px;
    }

    .timetable-day-title {
        font-size: 14px;
        font-weight: 700;
        color: #1E293B;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .timetable-slot {
        background: #F8FAFC;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        border-left: 3px solid #8B5CF6;
    }

    .timetable-slot-header {
        font-weight: 600;
        color: #1E293B;
        font-size: 13px;
        margin-bottom: 4px;
    }

    .timetable-slot-meta {
        font-size: 12px;
        color: #64748B;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    /* Loading State */
    .loading-overlay {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 10;
        align-items: center;
        justify-content: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-spinner {
        font-size: 36px;
        animation: spin 1s linear infinite;
        color: #4F46E5;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #94A3B8;
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: 18px;
        font-weight: 600;
        color: #64748B;
        margin-bottom: 8px;
    }

    .empty-state p {
        font-size: 14px;
        color: #94A3B8;
    }

    /* Alert */
    .alert {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 14px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 2000;
        display: none;
        align-items: center;
        gap: 10px;
        min-width: 300px;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .alert.active {
        display: flex;
    }

    .alert.success {
        background: #D1FAE5;
        color: #065F46;
        border-left: 4px solid #10B981;
    }

    .alert.error {
        background: #FEE2E2;
        color: #991B1B;
        border-left: 4px solid #DC2626;
    }

    .alert.warning {
        background: #FEF3C7;
        color: #92400E;
        border-left: 4px solid #F59E0B;
    }

    .alert-close {
        margin-left: auto;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        opacity: 0.7;
    }

    .alert-close:hover {
        opacity: 1;
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .toolbar {
            flex-direction: column;
        }

        .toolbar-left,
        .toolbar-right {
            width: 100%;
        }

        .search-box {
            min-width: 100%;
        }

        .toolbar-right {
            flex-wrap: wrap;
        }

        .detail-grid {
            grid-template-columns: 1fr;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .pagination {
            flex-direction: column;
            gap: 12px;
        }

        .pagination-controls {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class="bi bi-house-door"></i> Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Venue Management</li>
    </ol>
</nav>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <div class="stat-value">{{ stats.total_venues }}</div>
                <div class="stat-label">Total Venues</div>
            </div>
            <div class="stat-icon total">
                <i class="bi bi-building"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <div class="stat-value">{{ stats.available_venues }}</div>
                <div class="stat-label">Available</div>
            </div>
            <div class="stat-icon available">
                <i class="bi bi-check-circle"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <div class="stat-value">{{ stats.lecture_halls }}</div>
                <div class="stat-label">Lecture Halls</div>
            </div>
            <div class="stat-icon halls">
                <i class="bi bi-door-open"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <div class="stat-value">{{ stats.labs }}</div>
                <div class="stat-label">Laboratories</div>
            </div>
            <div class="stat-icon labs">
                <i class="bi bi-cpu"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <div class="stat-value">{{ stats.venues_with_projectors }}</div>
                <div class="stat-label">With Projector</div>
            </div>
            <div class="stat-icon projector">
                <i class="bi bi-projector"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <div class="stat-value">{{ stats.venues_with_computers }}</div>
                <div class="stat-label">With Computers</div>
            </div>
            <div class="stat-icon computers">
                <i class="bi bi-laptop"></i>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="section-container">
    <div style="position: relative;">
        <div class="loading-overlay" id="loadingOverlay">
            <i class="bi bi-hourglass-split loading-spinner"></i>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-left">
                <div class="search-box">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search venues..." />
                    <button class="clear-search" id="clearSearch">
                        <i class="bi bi-x-circle-fill"></i>
                    </button>
                </div>

                <select class="filter-select" id="venueTypeFilter">
                    <option value="">All Types</option>
                    {% for code, name in venue_types %}
                    <option value="{{ code }}">{{ name }}</option>
                    {% endfor %}
                </select>

                <select class="filter-select" id="availabilityFilter">
                    <option value="">All Status</option>
                    <option value="true">Available</option>
                    <option value="false">Unavailable</option>
                </select>

                <select class="filter-select" id="buildingFilter">
                    <option value="">All Buildings</option>
                </select>
            </div>

            <div class="toolbar-right">
                <button class="btn btn-secondary" onclick="exportVenues()">
                    <i class="bi bi-download"></i> Export
                </button>
                <button class="btn btn-primary" onclick="showAddModal()">
                    <i class="bi bi-plus-circle"></i> Add Venue
                </button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Building</th>
                        <th>Capacity</th>
                        <th>Features</th>
                        <th>Status</th>
                        <th>Timetable</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="venueTableBody">
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 60px;">
                            <i class="bi bi-hourglass-split loading-spinner"></i>
                            <p style="margin-top: 12px; color: #94A3B8;">Loading venues...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="paginationContainer" style="display: none;">
            <div class="pagination-info" id="paginationInfo"></div>
            <div class="pagination-controls" id="paginationControls"></div>
        </div>
    </div>
</div>

<!-- Add/Edit Venue Modal -->
<div class="modal" id="venueModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">
                <i class="bi bi-building"></i>
                <span id="modalTitleText">Add Venue</span>
            </h3>
            <button class="modal-close" onclick="closeModal('venueModal')">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="venueForm">
                <input type="hidden" id="venueId" />

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required" for="venueName">Venue Name</label>
                        <input type="text" class="form-input" id="venueName" placeholder="e.g., Main Lecture Hall" required />
                        <div class="form-error" id="venueNameError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label required" for="venueCode">Venue Code</label>
                        <input type="text" class="form-input" id="venueCode" placeholder="e.g., LH-101" required style="text-transform: uppercase;" />
                        <div class="form-error" id="venueCodeError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required" for="venueType">Venue Type</label>
                        <select class="form-select" id="venueType" required>
                            <option value="">Select Type</option>
                            {% for code, name in venue_types %}
                            <option value="{{ code }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-error" id="venueTypeError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label required" for="venueCapacity">Capacity</label>
                        <input type="number" class="form-input" id="venueCapacity" placeholder="e.g., 100" min="1" required />
                        <div class="form-error" id="venueCapacityError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required" for="venueBuilding">Building</label>
                        <input type="text" class="form-input" id="venueBuilding" placeholder="e.g., Business Block" required />
                        <div class="form-error" id="venueBuildingError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="venueFloor">Floor</label>
                        <input type="text" class="form-input" id="venueFloor" placeholder="e.g., Ground Floor" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Features</label>
                    <div class="form-checkbox-group">
                        <input type="checkbox" class="form-checkbox" id="hasProjector" />
                        <label class="form-checkbox-label" for="hasProjector">Has Projector</label>
                    </div>
                    <div class="form-checkbox-group">
                        <input type="checkbox" class="form-checkbox" id="hasComputers" />
                        <label class="form-checkbox-label" for="hasComputers">Has Computers</label>
                    </div>
                    <div class="form-checkbox-group">
                        <input type="checkbox" class="form-checkbox" id="isAvailable" checked />
                        <label class="form-checkbox-label" for="isAvailable">Is Available</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('venueModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveVenue()">
                <i class="bi bi-save"></i> Save Venue
            </button>
        </div>
    </div>
</div>

<!-- View Venue Details Modal -->
<div class="modal" id="viewModal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="bi bi-info-circle"></i>
                Venue Details
            </h3>
            <button class="modal-close" onclick="closeModal('viewModal')">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body" id="viewModalBody">
            <div style="text-align: center; padding: 40px;">
                <i class="bi bi-hourglass-split loading-spinner"></i>
                <p style="margin-top: 12px; color: #94A3B8;">Loading venue details...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('viewModal')">Close</button>
        </div>
    </div>
</div>

<!-- Alert -->
<div class="alert" id="alert">
    <i class="bi bi-check-circle-fill" id="alertIcon"></i>
    <span id="alertMessage"></span>
    <button class="alert-close" onclick="closeAlert()">
        <i class="bi bi-x"></i>
    </button>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let currentVenueId = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadVenues();
        loadBuildings();
        setupEventListeners();
    });

    // Setup event listeners
    function setupEventListeners() {
        // Search
        const searchInput = document.getElementById('searchInput');
        const clearSearch = document.getElementById('clearSearch');
        
        searchInput.addEventListener('input', function() {
            if (this.value) {
                clearSearch.style.display = 'block';
            } else {
                clearSearch.style.display = 'none';
            }
            debounce(loadVenues, 500)();
        });

        clearSearch.addEventListener('click', function() {
            searchInput.value = '';
            this.style.display = 'none';
            loadVenues();
        });

        // Filters
        document.getElementById('venueTypeFilter').addEventListener('change', loadVenues);
        document.getElementById('availabilityFilter').addEventListener('change', loadVenues);
        document.getElementById('buildingFilter').addEventListener('change', loadVenues);

        // Form validation
        document.getElementById('venueCode').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    }

    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Load venues
    async function loadVenues(page = 1) {
        showLoading(true);
        currentPage = page;

        const params = new URLSearchParams({
            page: page,
            per_page: 10,
            search: document.getElementById('searchInput').value,
            venue_type: document.getElementById('venueTypeFilter').value,
            availability: document.getElementById('availabilityFilter').value,
            building: document.getElementById('buildingFilter').value,
        });

        try {
            const response = await fetch(`/api/venues/list/?${params}`);
            const data = await response.json();

            if (data.success) {
                renderVenueTable(data.venues);
                renderPagination(data.pagination);
            } else {
                showAlert('error', data.error || 'Failed to load venues');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('error', 'An error occurred while loading venues');
        } finally {
            showLoading(false);
        }
    }

    // Render venue table
    function renderVenueTable(venues) {
        const tbody = document.getElementById('venueTableBody');

        if (venues.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9">
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <h3>No Venues Found</h3>
                            <p>Try adjusting your search or filters</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = venues.map(venue => `
            <tr>
                <td><span class="venue-code">${venue.code}</span></td>
                <td><span class="venue-name">${venue.name}</span></td>
                <td><span class="badge ${venue.venue_type_code.toLowerCase().replace('_', '-')}">${venue.venue_type}</span></td>
                <td>${venue.building} ${venue.floor !== '-' ? `(${venue.floor})` : ''}</td>
                <td>${venue.capacity}</td>
                <td>
                    <div class="feature-icons">
                        <div class="feature-icon ${venue.has_projector ? 'active' : 'inactive'}" title="${venue.has_projector ? 'Has Projector' : 'No Projector'}">
                            <i class="bi bi-projector"></i>
                        </div>
                        <div class="feature-icon ${venue.has_computers ? 'active' : 'inactive'}" title="${venue.has_computers ? 'Has Computers' : 'No Computers'}">
                            <i class="bi bi-laptop"></i>
                        </div>
                    </div>
                </td>
                <td><span class="badge ${venue.is_available ? 'available' : 'unavailable'}">${venue.is_available ? 'Available' : 'Unavailable'}</span></td>
                <td>${venue.timetable_count} slot${venue.timetable_count !== 1 ? 's' : ''}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn view" onclick="viewVenue(${venue.id})" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="action-btn edit" onclick="editVenue(${venue.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="action-btn toggle" onclick="toggleAvailability(${venue.id})" title="Toggle Availability">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteVenue(${venue.id}, '${venue.name}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Render pagination
    function renderPagination(pagination) {
        const container = document.getElementById('paginationContainer');
        const info = document.getElementById('paginationInfo');
        const controls = document.getElementById('paginationControls');

        if (pagination.total_items === 0) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'flex';

        const start = (pagination.current_page - 1) * pagination.per_page + 1;
        const end = Math.min(start + pagination.per_page - 1, pagination.total_items);
        info.textContent = `Showing ${start}-${end} of ${pagination.total_items} venues`;

        let controlsHTML = `
            <button class="pagination-btn" onclick="loadVenues(${pagination.current_page - 1})" ${!pagination.has_previous ? 'disabled' : ''}>
                <i class="bi bi-chevron-left"></i> Previous
            </button>
        `;

        for (let i = 1; i <= pagination.total_pages; i++) {
            if (i === 1 || i === pagination.total_pages || (i >= pagination.current_page - 1 && i <= pagination.current_page + 1)) {
                controlsHTML += `
                    <button class="pagination-btn ${i === pagination.current_page ? 'active' : ''}" onclick="loadVenues(${i})">
                        ${i}
                    </button>
                `;
            } else if (i === pagination.current_page - 2 || i === pagination.current_page + 2) {
                controlsHTML += `<span style="padding: 0 8px; color: #94A3B8;">...</span>`;
            }
        }

        controlsHTML += `
            <button class="pagination-btn" onclick="loadVenues(${pagination.current_page + 1})" ${!pagination.has_next ? 'disabled' : ''}>
                Next <i class="bi bi-chevron-right"></i>
            </button>
        `;

        controls.innerHTML = controlsHTML;
    }

    // Load buildings for filter
    async function loadBuildings() {
        try {
            const response = await fetch('/api/venues/buildings/');
            const data = await response.json();

            if (data.success) {
                const select = document.getElementById('buildingFilter');
                const currentValue = select.value;
                
                select.innerHTML = '<option value="">All Buildings</option>';
                data.buildings.forEach(building => {
                    const option = document.createElement('option');
                    option.value = building;
                    option.textContent = building;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            }
        } catch (error) {
            console.error('Error loading buildings:', error);
        }
    }

    // Show add modal
    function showAddModal() {
        currentVenueId = null;
        document.getElementById('modalTitleText').textContent = 'Add Venue';
        document.getElementById('venueForm').reset();
        document.getElementById('venueId').value = '';
        document.getElementById('isAvailable').checked = true;
        clearFormErrors();
        openModal('venueModal');
    }

    // Edit venue
    async function editVenue(venueId) {
        currentVenueId = venueId;
        document.getElementById('modalTitleText').textContent = 'Edit Venue';
        
        try {
            const response = await fetch(`/api/venues/${venueId}/`);
            const data = await response.json();

            if (data.success) {
                const venue = data.venue;
                document.getElementById('venueId').value = venue.id;
                document.getElementById('venueName').value = venue.name;
                document.getElementById('venueCode').value = venue.code;
                document.getElementById('venueType').value = venue.venue_type_code;
                document.getElementById('venueCapacity').value = venue.capacity;
                document.getElementById('venueBuilding').value = venue.building;
                document.getElementById('venueFloor').value = venue.floor;
                document.getElementById('hasProjector').checked = venue.has_projector;
                document.getElementById('hasComputers').checked = venue.has_computers;
                document.getElementById('isAvailable').checked = venue.is_available;
                
                clearFormErrors();
                openModal('venueModal');
            } else {
                showAlert('error', data.error || 'Failed to load venue details');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('error', 'An error occurred while loading venue details');
        }
    }

    // Save venue (create or update)
    async function saveVenue() {
        clearFormErrors();

        const venueData = {
            name: document.getElementById('venueName').value.trim(),
            code: document.getElementById('venueCode').value.trim().toUpperCase(),
            venue_type: document.getElementById('venueType').value,
            capacity: parseInt(document.getElementById('venueCapacity').value),
            building: document.getElementById('venueBuilding').value.trim(),
            floor: document.getElementById('venueFloor').value.trim(),
            has_projector: document.getElementById('hasProjector').checked,
            has_computers: document.getElementById('hasComputers').checked,
            is_available: document.getElementById('isAvailable').checked,
        };

        // Validation
        let hasErrors = false;

        if (!venueData.name) {
            showFieldError('venueName', 'Venue name is required');
            hasErrors = true;
        }

        if (!venueData.code) {
            showFieldError('venueCode', 'Venue code is required');
            hasErrors = true;
        }

        if (!venueData.venue_type) {
            showFieldError('venueType', 'Venue type is required');
            hasErrors = true;
        }

        if (!venueData.capacity || venueData.capacity < 1) {
            showFieldError('venueCapacity', 'Valid capacity is required');
            hasErrors = true;
        }

        if (!venueData.building) {
            showFieldError('venueBuilding', 'Building is required');
            hasErrors = true;
        }

        if (hasErrors) return;

        const isEdit = currentVenueId !== null;
        const url = isEdit ? `/api/venues/${currentVenueId}/update/` : '/api/venues/create/';
        const method = isEdit ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(venueData)
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', data.message);
                closeModal('venueModal');
                loadVenues(currentPage);
                loadBuildings(); // Refresh building filter
            } else {
                showAlert('error', data.error || 'Failed to save venue');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('error', 'An error occurred while saving venue');
        }
    }

    // View venue details
    async function viewVenue(venueId) {
        openModal('viewModal');

        try {
            const response = await fetch(`/api/venues/${venueId}/`);
            const data = await response.json();

            if (data.success) {
                renderVenueDetails(data.venue);
            } else {
                showAlert('error', data.error || 'Failed to load venue details');
                closeModal('viewModal');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('error', 'An error occurred while loading venue details');
            closeModal('viewModal');
        }
    }

    // Render venue details
    function renderVenueDetails(venue) {
        const modalBody = document.getElementById('viewModalBody');

        let html = `
            <div class="detail-section">
                <div class="detail-section-title">
                    <i class="bi bi-info-circle"></i>
                    Basic Information
                </div>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Venue Code</div>
                        <div class="detail-value">${venue.code}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Venue Name</div>
                        <div class="detail-value">${venue.name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Venue Type</div>
                        <div class="detail-value">${venue.venue_type}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Capacity</div>
                        <div class="detail-value">${venue.capacity} people</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Building</div>
                        <div class="detail-value">${venue.building}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Floor</div>
                        <div class="detail-value">${venue.floor || 'Not specified'}</div>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <div class="detail-section-title">
                    <i class="bi bi-gear"></i>
                    Features & Status
                </div>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Has Projector</div>
                        <div class="detail-value">
                            ${venue.has_projector ? '<span class="badge available">Yes</span>' : '<span class="badge unavailable">No</span>'}
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Has Computers</div>
                        <div class="detail-value">
                            ${venue.has_computers ? '<span class="badge available">Yes</span>' : '<span class="badge unavailable">No</span>'}
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Availability Status</div>
                        <div class="detail-value">
                            ${venue.is_available ? '<span class="badge available">Available</span>' : '<span class="badge unavailable">Unavailable</span>'}
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Active Timetable Slots</div>
                        <div class="detail-value">${venue.total_slots} slot${venue.total_slots !== 1 ? 's' : ''}</div>
                    </div>
                </div>
            </div>
        `;

        // Add timetable section if there are slots
        if (venue.total_slots > 0) {
            html += `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <i class="bi bi-calendar3"></i>
                        Weekly Timetable (Current Semester)
                    </div>
                    <div class="timetable-list">
            `;

            const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            dayOrder.forEach(day => {
                if (venue.timetable[day]) {
                    html += `
                        <div class="timetable-day">
                            <div class="timetable-day-title">
                                <i class="bi bi-calendar-day"></i>
                                ${day}
                            </div>
                    `;

                    venue.timetable[day].forEach(slot => {
                        html += `
                            <div class="timetable-slot">
                                <div class="timetable-slot-header">
                                    ${slot.unit_code} - ${slot.unit_name}
                                </div>
                                <div class="timetable-slot-meta">
                                    <span><i class="bi bi-clock"></i> ${slot.start_time} - ${slot.end_time}</span>
                                    <span><i class="bi bi-person"></i> ${slot.lecturer}</span>
                                    <span><i class="bi bi-mortarboard"></i> ${slot.programme} Year ${slot.year_level}</span>
                                </div>
                            </div>
                        `;
                    });

                    html += `</div>`;
                }
            });

            html += `
                    </div>
                </div>
            `;
        }

        modalBody.innerHTML = html;
    }

    // Toggle availability
    async function toggleAvailability(venueId) {
        if (!confirm('Are you sure you want to toggle the availability status of this venue?')) {
            return;
        }

        try {
            const response = await fetch(`/api/venues/${venueId}/toggle-availability/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', data.message);
                loadVenues(currentPage);
            } else {
                showAlert('error', data.error || 'Failed to toggle availability');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('error', 'An error occurred while toggling availability');
        }
    }

    // Delete venue
    async function deleteVenue(venueId, venueName) {
        if (!confirm(`Are you sure you want to delete "${venueName}"?\n\nThis action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/venues/${venueId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', data.message);
                loadVenues(currentPage);
            } else {
                showAlert('error', data.error || 'Failed to delete venue');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('error', 'An error occurred while deleting venue');
        }
    }

    // Export venues
    async function exportVenues() {
        try {
            const response = await fetch('/api/venues/export/');
            const data = await response.json();

            if (data.success) {
                // Convert to CSV
                const headers = ['Code', 'Name', 'Type', 'Capacity', 'Building', 'Floor', 'Projector', 'Computers', 'Available'];
                const csvContent = [
                    headers.join(','),
                    ...data.venues.map(v => [
                        v.code,
                        `"${v.name}"`,
                        v.type,
                        v.capacity,
                        `"${v.building}"`,
                        v.floor,
                        v.projector,
                        v.computers,
                        v.available
                    ].join(','))
                ].join('\n');

                // Download
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `venues_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);

                showAlert('success', `Exported ${data.total} venues successfully`);
            } else {
                showAlert('error', data.error || 'Failed to export venues');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('error', 'An error occurred while exporting venues');
        }
    }

    // Utility functions
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    function showLoading(show) {
        document.getElementById('loadingOverlay').classList.toggle('active', show);
    }

    function showAlert(type, message) {
        const alert = document.getElementById('alert');
        const alertIcon = document.getElementById('alertIcon');
        const alertMessage = document.getElementById('alertMessage');

        // Set icon based on type
        const icons = {
            success: 'bi-check-circle-fill',
            error: 'bi-x-circle-fill',
            warning: 'bi-exclamation-triangle-fill'
        };

        alertIcon.className = `bi ${icons[type] || icons.success}`;
        alertMessage.textContent = message;

        // Remove existing type classes and add new one
        alert.className = 'alert active ' + type;

        // Auto hide after 5 seconds
        setTimeout(() => {
            closeAlert();
        }, 5000);
    }

    function closeAlert() {
        document.getElementById('alert').classList.remove('active');
    }

    function showFieldError(fieldId, message) {
        const errorElement = document.getElementById(fieldId + 'Error');
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.classList.add('active');
            document.getElementById(fieldId).style.borderColor = '#DC2626';
        }
    }

    function clearFormErrors() {
        const errorElements = document.querySelectorAll('.form-error');
        errorElements.forEach(el => {
            el.classList.remove('active');
            el.textContent = '';
        });

        const inputs = document.querySelectorAll('.form-input, .form-select');
        inputs.forEach(input => {
            input.style.borderColor = '#E2E8F0';
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Close modals on outside click
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
    }

    // Close modals on ESC key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modals = document.querySelectorAll('.modal.active');
            modals.forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = 'auto';
        }
    });

    console.log('Venue management system loaded successfully');
</script>
{% endblock %}