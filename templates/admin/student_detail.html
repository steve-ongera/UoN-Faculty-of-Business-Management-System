{% extends 'admin_base.html' %}
{% load static %}
{% block title %}{{ student.registration_number }} - Student Details{% endblock %}

{% block page_title %}Student Details{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<link rel='stylesheet' href='{% static 'css/student_detail.css' %}'>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class="bi bi-house-door"></i> Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'student_list' %}">Students</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ student.registration_number }}</li>
    </ol>
</nav>

<!-- Action Bar -->
<div class="action-bar">
    <a href="{% url 'student_list' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to List
    </a>
    <div style="display: flex; gap: 10px;">
        <a href="{% url 'student_update' student.registration_number %}" class="btn btn-warning">
            <i class="bi bi-pencil"></i> Edit Student
        </a>
        <a href="{% url 'student_delete' student.registration_number %}" class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete
        </a>
    </div>
</div>

<!-- Student Header -->
<div class="student-header">
    <div class="student-avatar">
        {{ student.first_name|first }}{{ student.last_name|first }}
    </div>
    <div class="student-info">
        <h2>{{ student.first_name }} {{ student.last_name }} {{ student.surname }}</h2>
        <div class="student-meta">
            <span class="meta-item">
                <i class="bi bi-hash"></i>
                {{ student.registration_number }}
            </span>
            <span class="meta-item">
                <i class="bi bi-envelope"></i>
                {{ student.email|default:"No email" }}
            </span>
            <span class="meta-item">
                <i class="bi bi-telephone"></i>
                {{ student.phone|default:"No phone" }}
            </span>
            <span>
                {% if student.is_active %}
                <span class="badge badge-success">Active</span>
                {% else %}
                <span class="badge badge-danger">Inactive</span>
                {% endif %}
            </span>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Enrollments</div>
        <div class="stat-value">{{ total_enrollments }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Completed Units</div>
        <div class="stat-value">{{ completed_units }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Current Enrollments</div>
        <div class="stat-value">{{ current_enrollments }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Failed Units</div>
        <div class="stat-value">{{ failed_units }}</div>
    </div>
</div>

<!-- Academic Information -->
<div class="section-container">
    <h3 class="section-title"><i class="bi bi-mortarboard"></i> Academic Information</h3>
    <div class="info-grid">
        <div class="info-item">
            <span class="info-label">Programme</span>
            <span class="info-value">{{ student.programme.code }} - {{ student.programme.name }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Department</span>
            <span class="info-value">{{ student.programme.department.name }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Current Year</span>
            <span class="info-value">Year {{ student.current_year }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Intake</span>
            <span class="info-value">{{ student.intake.name }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Admission Date</span>
            <span class="info-value">{{ student.admission_date|date:"d M Y" }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Can Upgrade</span>
            <span class="info-value">{{ student.can_upgrade|yesno:"Yes,No" }}</span>
        </div>
    </div>
</div>

<!-- Personal Information -->
<div class="section-container">
    <h3 class="section-title"><i class="bi bi-person"></i> Personal Information</h3>
    <div class="info-grid">
        <div class="info-item">
            <span class="info-label">Date of Birth</span>
            <span class="info-value">{{ student.date_of_birth|date:"d M Y"|default:"-" }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Address</span>
            <span class="info-value">{{ student.address|default:"-" }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Parent Name</span>
            <span class="info-value">{{ student.parent_name|default:"-" }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Parent Phone</span>
            <span class="info-value">{{ student.parent_phone|default:"-" }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Guardian Name</span>
            <span class="info-value">{{ student.guardian_name|default:"-" }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Guardian Phone</span>
            <span class="info-value">{{ student.guardian_phone|default:"-" }}</span>
        </div>
    </div>
</div>

<!-- Recent Enrollments -->
<div class="section-container">
    <h3 class="section-title"><i class="bi bi-journal-text"></i> Recent Unit Enrollments</h3>
    {% if enrollments %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Unit Code</th>
                    <th>Unit Name</th>
                    <th>Semester</th>
                    <th>Enrollment Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for enrollment in enrollments %}
                <tr>
                    <td><strong>{{ enrollment.unit.code }}</strong></td>
                    <td>{{ enrollment.unit.name }}</td>
                    <td>{{ enrollment.semester }}</td>
                    <td>{{ enrollment.enrollment_date|date:"d M Y" }}</td>
                    <td>
                        {% if enrollment.status == 'ENROLLED' %}
                        <span class="badge badge-success">{{ enrollment.get_status_display }}</span>
                        {% elif enrollment.status == 'COMPLETED' %}
                        <span class="badge badge-success">{{ enrollment.get_status_display }}</span>
                        {% else %}
                        <span class="badge badge-danger">{{ enrollment.get_status_display }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="color: #64748B; text-align: center; padding: 20px;">No enrollments found.</p>
    {% endif %}
</div>

<!-- Semester Registrations -->
<div class="section-container">
    <h3 class="section-title"><i class="bi bi-calendar-check"></i> Semester Registrations</h3>
    {% if registrations %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Semester</th>
                    <th>Registration Date</th>
                    <th>Units Enrolled</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for reg in registrations %}
                <tr>
                    <td><strong>{{ reg.semester }}</strong></td>
                    <td>{{ reg.registration_date|date:"d M Y H:i" }}</td>
                    <td>{{ reg.units_enrolled }}</td>
                    <td>
                        {% if reg.status == 'REGISTERED' %}
                        <span class="badge badge-success">{{ reg.get_status_display }}</span>
                        {% else %}
                        <span class="badge badge-danger">{{ reg.get_status_display }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="color: #64748B; text-align: center; padding: 20px;">No registrations found.</p>
    {% endif %}
</div>

<!-- Progression History -->
{% if progressions %}
<div class="section-container">
    <h3 class="section-title"><i class="bi bi-arrow-up-circle"></i> Progression History</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>From Programme</th>
                    <th>To Programme</th>
                    <th>Completion Date</th>
                    <th>Upgrade Date</th>
                </tr>
            </thead>
            <tbody>
                {% for prog in progressions %}
                <tr>
                    <td>{{ prog.from_programme.name }}</td>
                    <td>{{ prog.to_programme.name|default:"Graduated" }}</td>
                    <td>{{ prog.completion_date|date:"d M Y" }}</td>
                    <td>{{ prog.upgrade_date|date:"d M Y"|default:"-" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    console.log('Student detail loaded');
</script>
{% endblock %}
