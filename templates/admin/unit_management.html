{% extends 'admin_base.html' %}
{% load static %}
{% block title %}Unit Management{% endblock %}

{% block page_title %}Unit Management by Programmes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<link rel='stylesheet' href='{% static 'css/unit_management.css' %}'>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class="bi bi-house-door"></i> Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Unit Management</li>
    </ol>
</nav>

<!-- Action Bar -->
<div class="action-bar">
    <h2 style="margin: 0; color: #1E293B;">Units by Programme</h2>
    <button class="btn btn-primary" onclick="openUnitModal()">
        <i class="bi bi-plus-circle"></i> Create New Unit
    </button>
</div>

<!-- Programmes Grid -->
<div class="programme-grid">
    {% for programme in programmes %}
    <div class="programme-card" data-programme-id="{{ programme.id }}">
        <div class="card-header">
            <h3>
                <i class="bi bi-mortarboard"></i>
                {{ programme.code }} - {{ programme.name }}
                <span class="badge badge-info">{{ programme.level }}</span>
            </h3>
            <div class="card-header-actions">
                <button class="btn btn-sm btn-success" onclick="openAssignModal({{ programme.id }}, '{{ programme.code }}')">
                    <i class="bi bi-plus"></i> Assign Unit
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="programme-meta">
                <div class="meta-item">
                    <span class="meta-label">Department</span>
                    <span class="meta-value">{{ programme.department.code }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Duration</span>
                    <span class="meta-value">{{ programme.duration_years }} Year(s)</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Semesters/Year</span>
                    <span class="meta-value">{{ programme.semesters_per_year }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Total Units</span>
                    <span class="meta-value">{{ programme.unit_count }}</span>
                </div>
            </div>

            <!-- Units Section -->
            <div class="units-section">
                <div class="section-header">
                    <h4 class="section-title">
                        <i class="bi bi-journal-text"></i>
                        Units
                    </h4>
                </div>

                <div class="unit-list" id="unitList{{ programme.id }}">
                    <!-- Units will be loaded here via JavaScript -->
                    <div class="loading show">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <h3>No Programmes Found</h3>
        <p>Add programmes to start managing units.</p>
    </div>
    {% endfor %}
</div>

<!-- Create/Edit Unit Modal -->
<div id="unitModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="unitModalTitle">Create New Unit</h4>
            <button class="modal-close" onclick="closeUnitModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="unitAlert"></div>
            <form id="unitForm">
                <input type="hidden" id="unitId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="unitCode">Unit Code *</label>
                        <input type="text" id="unitCode" placeholder="e.g., BUS 101" required>
                    </div>

                    <div class="form-group">
                        <label for="creditHours">Credit Hours *</label>
                        <input type="number" id="creditHours" min="1" max="10" value="3" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="unitName">Unit Name *</label>
                    <input type="text" id="unitName" placeholder="Enter unit name" required>
                </div>

                <div class="form-group">
                    <label for="unitDescription">Description</label>
                    <textarea id="unitDescription" placeholder="Enter unit description"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="unitDepartment">Department *</label>
                        <select id="unitDepartment" required>
                            <option value="">Select Department</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="unitPrerequisites">Prerequisites</label>
                        <select id="unitPrerequisites" multiple style="height: 100px;">
                            {% for unit in all_units %}
                            <option value="{{ unit.id }}">{{ unit.code }} - {{ unit.name }}</option>
                            {% endfor %}
                        </select>
                        <small style="color: #64748B; font-size: 12px;">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isCore" checked>
                        <label for="isCore" style="margin: 0;">Core Unit (uncheck for Elective)</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeUnitModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveUnit()">
                <i class="bi bi-save"></i> Save Unit
            </button>
        </div>
    </div>
</div>

<!-- Assign Unit to Programme Modal -->
<div id="assignModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="assignModalTitle">Assign Unit to Programme</h4>
            <button class="modal-close" onclick="closeAssignModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="assignAlert"></div>
            <form id="assignForm">
                <input type="hidden" id="assignProgrammeId">
                <input type="hidden" id="assignProgrammeUnitId">
                
                <div class="form-group">
                    <label for="assignProgrammeName">Programme</label>
                    <input type="text" id="assignProgrammeName" readonly style="background: #F8FAFC;">
                </div>

                <div class="form-group">
                    <label for="searchUnit">Search Unit *</label>
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" id="searchUnit" placeholder="Type to search units..." autocomplete="off">
                    </div>
                    <div id="searchResults" class="search-results" style="display: none;"></div>
                    <input type="hidden" id="selectedUnitId">
                    <div id="selectedUnitDisplay" style="margin-top: 10px; display: none;">
                        <div class="alert alert-info">
                            <i class="bi bi-check-circle"></i>
                            <span id="selectedUnitText"></span>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="assignYear">Year Level *</label>
                        <select id="assignYear" required>
                            <option value="">Select Year</option>
                            <option value="1">Year 1</option>
                            <option value="2">Year 2</option>
                            <option value="3">Year 3</option>
                            <option value="4">Year 4</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="assignSemester">Semester *</label>
                        <select id="assignSemester" required>
                            <option value="">Select Semester</option>
                            <option value="1">Semester 1</option>
                            <option value="2">Semester 2</option>
                            <option value="3">Semester 3</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isMandatory" checked>
                        <label for="isMandatory" style="margin: 0;">Mandatory Unit</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAssignModal()">Cancel</button>
            <button class="btn btn-success" onclick="saveAssignment()">
                <i class="bi bi-check-circle"></i> Assign Unit
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h4>Confirm Delete</h4>
            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="deleteAlert"></div>
            <p id="deleteMessage" style="color: #64748B;">Are you sure you want to delete this item?</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmDelete()">
                <i class="bi bi-trash"></i> Delete
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let deleteCallback = null;
let searchTimeout = null;

// ========================
// UNIT CRUD FUNCTIONS
// ========================

function openUnitModal(unitId = null) {
    document.getElementById('unitForm').reset();
    document.getElementById('unitAlert').innerHTML = '';
    
    if (unitId) {
        document.getElementById('unitModalTitle').textContent = 'Edit Unit';
        loadUnitData(unitId);
    } else {
        document.getElementById('unitModalTitle').textContent = 'Create New Unit';
        document.getElementById('unitId').value = '';
    }
    
    document.getElementById('unitModal').classList.add('show');
}

function closeUnitModal() {
    document.getElementById('unitModal').classList.remove('show');
}

function loadUnitData(unitId) {
    fetch(`/admin-units/get/${unitId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('unitId').value = data.data.id;
                document.getElementById('unitCode').value = data.data.code;
                document.getElementById('unitName').value = data.data.name;
                document.getElementById('unitDescription').value = data.data.description;
                document.getElementById('creditHours').value = data.data.credit_hours;
                document.getElementById('unitDepartment').value = data.data.department_id;
                document.getElementById('isCore').checked = data.data.is_core;
                
                // Set prerequisites
                const prereqSelect = document.getElementById('unitPrerequisites');
                Array.from(prereqSelect.options).forEach(option => {
                    option.selected = data.data.prerequisites.includes(parseInt(option.value));
                });
            }
        })
        .catch(error => console.error('Error:', error));
}

function saveUnit() {
    const unitId = document.getElementById('unitId').value;
    
    // Get selected prerequisites
    const prereqSelect = document.getElementById('unitPrerequisites');
    const prerequisites = Array.from(prereqSelect.selectedOptions).map(option => parseInt(option.value));
    
    const data = {
        code: document.getElementById('unitCode').value,
        name: document.getElementById('unitName').value,
        description: document.getElementById('unitDescription').value,
        credit_hours: document.getElementById('creditHours').value,
        department_id: document.getElementById('unitDepartment').value,
        is_core: document.getElementById('isCore').checked,
        prerequisites: prerequisites
    };

    const url = unitId ? `/admin-units/${unitId}/update/` : '/admin-units/create/';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('unitAlert', 'success', data.message);
            setTimeout(() => {
                closeUnitModal();
                location.reload();
            }, 1500);
        } else {
            showAlert('unitAlert', 'danger', data.message);
        }
    })
    .catch(error => {
        showAlert('unitAlert', 'danger', 'An error occurred. Please try again.');
        console.error('Error:', error);
    });
}

function deleteUnit(unitId) {
    deleteCallback = () => {
        fetch(`/admin-units/${unitId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('deleteAlert', 'success', data.message);
                setTimeout(() => {
                    closeDeleteModal();
                    location.reload();
                }, 1500);
            } else {
                showAlert('deleteAlert', 'danger', data.message);
            }
        })
        .catch(error => {
            showAlert('deleteAlert', 'danger', 'An error occurred. Please try again.');
            console.error('Error:', error);
        });
    };
    
    document.getElementById('deleteMessage').textContent = 
        'Are you sure you want to delete this unit? This action cannot be undone.';
    document.getElementById('deleteModal').classList.add('show');
}

// ========================
// PROGRAMME UNIT FUNCTIONS
// ========================

function loadProgrammeUnits(programmeId) {
    const container = document.getElementById(`unitList${programmeId}`);
    
    fetch(`/admin-programme/${programmeId}/units/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <i class="bi bi-inbox" style="font-size: 32px;"></i>
                            <p style="margin: 10px 0 0 0; font-size: 14px;">No units assigned yet.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.data.map(unit => `
                        <div class="unit-item">
                            <div class="unit-info">
                                <div class="unit-title">
                                    <span class="unit-code">${unit.unit_code}</span>
                                    <span>${unit.unit_name}</span>
                                    ${unit.is_mandatory ? '<span class="badge badge-success">Mandatory</span>' : '<span class="badge badge-warning">Elective</span>'}
                                    ${unit.is_core ? '<span class="badge badge-info">Core</span>' : '<span class="badge badge-secondary">Elective</span>'}
                                </div>
                                <div class="unit-details">
                                    <span><i class="bi bi-building"></i> ${unit.department}</span>
                                    <span><i class="bi bi-award"></i> ${unit.credit_hours} Credits</span>
                                    <span><i class="bi bi-calendar3"></i> ${unit.year_display}</span>
                                    <span><i class="bi bi-journal"></i> ${unit.semester_display}</span>
                                </div>
                            </div>
                            <div class="unit-actions">
                                <a href="/admin-units/${unit.unit_id}/" class="btn btn-sm btn-info">
                                    <i class="bi bi-eye"></i> View
                                </a>
                                <button class="btn btn-sm btn-warning" onclick="editUnit(${unit.unit_id})">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="editAssignment(${unit.id})">
                                    <i class="bi bi-gear"></i> Config
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="removeUnitFromProgramme(${unit.id})">
                                    <i class="bi bi-x-circle"></i> Remove
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        })
        .catch(error => {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Failed to load units.
                </div>
            `;
            console.error('Error:', error);
        });
}

function editUnit(unitId) {
    openUnitModal(unitId);
}

// ========================
// ASSIGNMENT FUNCTIONS
// ========================

function openAssignModal(programmeId, programmeName) {
    document.getElementById('assignForm').reset();
    document.getElementById('assignAlert').innerHTML = '';
    document.getElementById('assignProgrammeId').value = programmeId;
    document.getElementById('assignProgrammeName').value = programmeName;
    document.getElementById('assignProgrammeUnitId').value = '';
    document.getElementById('selectedUnitId').value = '';
    document.getElementById('selectedUnitDisplay').style.display = 'none';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('searchUnit').value = '';
    
    document.getElementById('assignModalTitle').textContent = 'Assign Unit to Programme';
    document.getElementById('assignModal').classList.add('show');
}

function closeAssignModal() {
    document.getElementById('assignModal').classList.remove('show');
}

// Unit search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchUnit');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                const programmeId = document.getElementById('assignProgrammeId').value;
                searchUnits(query, programmeId);
            }, 300);
        });
    }
});

function searchUnits(query, programmeId) {
    fetch(`/admin-units/search/?q=${encodeURIComponent(query)}&programme_id=${programmeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const resultsContainer = document.getElementById('searchResults');
                if (data.data.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-item">No units found</div>';
                } else {
                    resultsContainer.innerHTML = data.data.map(unit => `
                        <div class="search-item" onclick="selectUnit(${unit.id}, '${unit.code}', '${unit.name.replace(/'/g, "\\'")}')">
                            <strong>${unit.code}</strong> - ${unit.name}
                            <br><small style="color: #64748B;">${unit.department} • ${unit.credit_hours} Credits</small>
                        </div>
                    `).join('');
                }
                resultsContainer.style.display = 'block';
            }
        })
        .catch(error => console.error('Error:', error));
}

function selectUnit(unitId, unitCode, unitName) {
    document.getElementById('selectedUnitId').value = unitId;
    document.getElementById('selectedUnitText').textContent = `${unitCode} - ${unitName}`;
    document.getElementById('selectedUnitDisplay').style.display = 'block';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('searchUnit').value = `${unitCode} - ${unitName}`;
}

function saveAssignment() {
    const programmeUnitId = document.getElementById('assignProgrammeUnitId').value;
    const programmeId = document.getElementById('assignProgrammeId').value;
    const unitId = document.getElementById('selectedUnitId').value;
    
    if (!unitId && !programmeUnitId) {
        showAlert('assignAlert', 'danger', 'Please select a unit');
        return;
    }
    
    const data = {
        unit_id: unitId,
        year_level: document.getElementById('assignYear').value,
        semester: document.getElementById('assignSemester').value,
        is_mandatory: document.getElementById('isMandatory').checked
    };

    const url = programmeUnitId 
        ? `/admin-programme-unit/${programmeUnitId}/update/`
        : `/admin-programme/${programmeId}/units/assign/`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('assignAlert', 'success', data.message);
            setTimeout(() => {
                closeAssignModal();
                loadProgrammeUnits(programmeId);
            }, 1500);
        } else {
            showAlert('assignAlert', 'danger', data.message);
        }
    })
    .catch(error => {
        showAlert('assignAlert', 'danger', 'An error occurred. Please try again.');
        console.error('Error:', error);
    });
}

function editAssignment(programmeUnitId) {
    fetch(`/admin-programme-unit/${programmeUnitId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('assignProgrammeUnitId').value = data.data.id;
                document.getElementById('assignProgrammeId').value = data.data.programme_id;
                document.getElementById('assignYear').value = data.data.year_level;
                document.getElementById('assignSemester').value = data.data.semester;
                document.getElementById('isMandatory').checked = data.data.is_mandatory;
                document.getElementById('selectedUnitId').value = data.data.unit_id;
                
                // Hide search, show selected unit
                document.getElementById('searchUnit').parentElement.parentElement.style.display = 'none';
                
                document.getElementById('assignModalTitle').textContent = 'Edit Unit Assignment';
                document.getElementById('assignModal').classList.add('show');
            }
        })
        .catch(error => console.error('Error:', error));
}

function removeUnitFromProgramme(programmeUnitId) {
    deleteCallback = () => {
        fetch(`/admin-programme-unit/${programmeUnitId}/remove/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('deleteAlert', 'success', data.message);
                setTimeout(() => {
                    closeDeleteModal();
                    location.reload();
                }, 1500);
            } else {
                showAlert('deleteAlert', 'danger', data.message);
            }
        })
        .catch(error => {
            showAlert('deleteAlert', 'danger', 'An error occurred. Please try again.');
            console.error('Error:', error);
        });
    };
    
    document.getElementById('deleteMessage').textContent = 
        'Are you sure you want to remove this unit from the programme?';
    document.getElementById('deleteModal').classList.add('show');
}

// ========================
// UTILITY FUNCTIONS
// ========================

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('show');
    document.getElementById('deleteAlert').innerHTML = '';
    deleteCallback = null;
}

function confirmDelete() {
    if (deleteCallback) {
        deleteCallback();
    }
}

function showAlert(containerId, type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'danger' ? 'alert-danger' : 'alert-info';
    const icon = type === 'success' ? 'check-circle' : 
                 type === 'danger' ? 'exclamation-triangle' : 'info-circle';
    
    document.getElementById(containerId).innerHTML = `
        <div class="alert ${alertClass}">
            <i class="bi bi-${icon}"></i>
            ${message}
        </div>
    `;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Load programme units on page load
document.addEventListener('DOMContentLoaded', function() {
    {% for programme in programmes %}
    loadProgrammeUnits({{ programme.id }});
    {% endfor %}
});

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('show');
    }
}
</script>
{% endblock %}
