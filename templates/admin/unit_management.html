{% extends 'admin_base.html' %}

{% block title %}Unit Management{% endblock %}

{% block page_title %}Unit Management by Programmes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
    .breadcrumb {
        padding: 0;
        margin-bottom: 20px;
        font-size: 14px;
        list-style: none;
        display: flex;
        flex-wrap: wrap;
    }

    .breadcrumb-item {
        color: #64748B;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "/ ";
        color: #94A3B8;
        padding: 0 8px;
    }

    .breadcrumb-item.active {
        color: #1E293B;
        font-weight: 500;
    }

    .breadcrumb a {
        color: #4F46E5;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        color: #4338CA;
    }

    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
    }

    .btn-primary {
        background: #4F46E5;
        color: white;
    }

    .btn-primary:hover {
        background: #4338CA;
    }

    .btn-success {
        background: #10B981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-warning {
        background: #F59E0B;
        color: white;
    }

    .btn-warning:hover {
        background: #D97706;
    }

    .btn-danger {
        background: #EF4444;
        color: white;
    }

    .btn-danger:hover {
        background: #DC2626;
    }

    .btn-secondary {
        background: #64748B;
        color: white;
    }

    .btn-secondary:hover {
        background: #475569;
    }

    .btn-info {
        background: #3B82F6;
        color: white;
    }

    .btn-info:hover {
        background: #2563EB;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }

    .programme-grid {
        display: grid;
        gap: 20px;
    }

    .programme-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
        overflow: hidden;
    }

    .card-header {
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .card-header h3 {
        margin: 0;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }

    .card-header-actions {
        display: flex;
        gap: 8px;
    }

    .card-body {
        padding: 20px;
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-success {
        background: #D1FAE5;
        color: #065F46;
    }

    .badge-info {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .badge-warning {
        background: #FEF3C7;
        color: #92400E;
    }

    .badge-secondary {
        background: #F1F5F9;
        color: #475569;
    }

    .programme-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #F1F5F9;
    }

    .meta-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .meta-label {
        font-size: 12px;
        font-weight: 600;
        color: #64748B;
    }

    .meta-value {
        font-size: 14px;
        color: #1E293B;
        font-weight: 500;
    }

    .units-section {
        margin-top: 15px;
    }

    

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .section-title {
        font-size: 16px;
        font-weight: 600;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .unit-list {
        display: grid;
        gap: 12px;
    }

    .unit-item {
        background: #F8FAFC;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #E2E8F0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
    }

    .unit-item:hover {
        border-color: #CBD5E1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .unit-info {
        flex: 1;
    }

    .unit-title {
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .unit-code {
        color: #4F46E5;
        font-family: monospace;
    }

    .unit-details {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        font-size: 13px;
        color: #64748B;
    }

    .unit-details span {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .unit-actions {
        display: flex;
        gap: 8px;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #64748B;
    }

    .empty-state i {
        font-size: 48px;
        color: #CBD5E1;
        margin-bottom: 15px;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
    }

   .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #E2E8F0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h4 {
        margin: 0;
        color: #1E293B;
        font-size: 18px;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        color: #64748B;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: #F1F5F9;
        color: #1E293B;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #E2E8F0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #1E293B;
        font-weight: 600;
        font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #E2E8F0;
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.2s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #4F46E5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        cursor: pointer;
    }

    .alert {
        padding: 12px 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alert-success {
        background: #D1FAE5;
        color: #065F46;
        border: 1px solid #A7F3D0;
    }

    .alert-danger {
        background: #FEE2E2;
        color: #991B1B;
        border: 1px solid #FECACA;
    }

    .alert-info {
        background: #DBEAFE;
        color: #1E40AF;
        border: 1px solid #BFDBFE;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .search-box {
        position: relative;
        margin-bottom: 15px;
    }

    .search-box input {
        padding-left: 40px;
    }

    .search-box i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748B;
    }

    .search-results {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #E2E8F0;
        border-radius: 5px;
        margin-top: 10px;
    }

    .search-item {
        padding: 12px;
        border-bottom: 1px solid #F1F5F9;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .search-item:hover {
        background: #F8FAFC;
    }

    .search-item:last-child {
        border-bottom: none;
    }

    @media (max-width: 768px) {
        .programme-meta {
            grid-template-columns: 1fr;
        }

        .unit-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .unit-actions {
            width: 100%;
            justify-content: flex-end;
        }

        .card-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .card-header-actions {
            width: 100%;
            justify-content: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class="bi bi-house-door"></i> Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Unit Management</li>
    </ol>
</nav>

<!-- Action Bar -->
<div class="action-bar">
    <h2 style="margin: 0; color: #1E293B;">Units by Programme</h2>
    <button class="btn btn-primary" onclick="openUnitModal()">
        <i class="bi bi-plus-circle"></i> Create New Unit
    </button>
</div>

<!-- Programmes Grid -->
<div class="programme-grid">
    {% for programme in programmes %}
    <div class="programme-card" data-programme-id="{{ programme.id }}">
        <div class="card-header">
            <h3>
                <i class="bi bi-mortarboard"></i>
                {{ programme.code }} - {{ programme.name }}
                <span class="badge badge-info">{{ programme.level }}</span>
            </h3>
            <div class="card-header-actions">
                <button class="btn btn-sm btn-success" onclick="openAssignModal({{ programme.id }}, '{{ programme.code }}')">
                    <i class="bi bi-plus"></i> Assign Unit
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="programme-meta">
                <div class="meta-item">
                    <span class="meta-label">Department</span>
                    <span class="meta-value">{{ programme.department.code }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Duration</span>
                    <span class="meta-value">{{ programme.duration_years }} Year(s)</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Semesters/Year</span>
                    <span class="meta-value">{{ programme.semesters_per_year }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Total Units</span>
                    <span class="meta-value">{{ programme.unit_count }}</span>
                </div>
            </div>

            <!-- Units Section -->
            <div class="units-section">
                <div class="section-header">
                    <h4 class="section-title">
                        <i class="bi bi-journal-text"></i>
                        Units
                    </h4>
                </div>

                <div class="unit-list" id="unitList{{ programme.id }}">
                    <!-- Units will be loaded here via JavaScript -->
                    <div class="loading show">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <h3>No Programmes Found</h3>
        <p>Add programmes to start managing units.</p>
    </div>
    {% endfor %}
</div>

<!-- Create/Edit Unit Modal -->
<div id="unitModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="unitModalTitle">Create New Unit</h4>
            <button class="modal-close" onclick="closeUnitModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="unitAlert"></div>
            <form id="unitForm">
                <input type="hidden" id="unitId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="unitCode">Unit Code *</label>
                        <input type="text" id="unitCode" placeholder="e.g., BUS 101" required>
                    </div>

                    <div class="form-group">
                        <label for="creditHours">Credit Hours *</label>
                        <input type="number" id="creditHours" min="1" max="10" value="3" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="unitName">Unit Name *</label>
                    <input type="text" id="unitName" placeholder="Enter unit name" required>
                </div>

                <div class="form-group">
                    <label for="unitDescription">Description</label>
                    <textarea id="unitDescription" placeholder="Enter unit description"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="unitDepartment">Department *</label>
                        <select id="unitDepartment" required>
                            <option value="">Select Department</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="unitPrerequisites">Prerequisites</label>
                        <select id="unitPrerequisites" multiple style="height: 100px;">
                            {% for unit in all_units %}
                            <option value="{{ unit.id }}">{{ unit.code }} - {{ unit.name }}</option>
                            {% endfor %}
                        </select>
                        <small style="color: #64748B; font-size: 12px;">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isCore" checked>
                        <label for="isCore" style="margin: 0;">Core Unit (uncheck for Elective)</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeUnitModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveUnit()">
                <i class="bi bi-save"></i> Save Unit
            </button>
        </div>
    </div>
</div>

<!-- Assign Unit to Programme Modal -->
<div id="assignModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="assignModalTitle">Assign Unit to Programme</h4>
            <button class="modal-close" onclick="closeAssignModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="assignAlert"></div>
            <form id="assignForm">
                <input type="hidden" id="assignProgrammeId">
                <input type="hidden" id="assignProgrammeUnitId">
                
                <div class="form-group">
                    <label for="assignProgrammeName">Programme</label>
                    <input type="text" id="assignProgrammeName" readonly style="background: #F8FAFC;">
                </div>

                <div class="form-group">
                    <label for="searchUnit">Search Unit *</label>
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" id="searchUnit" placeholder="Type to search units..." autocomplete="off">
                    </div>
                    <div id="searchResults" class="search-results" style="display: none;"></div>
                    <input type="hidden" id="selectedUnitId">
                    <div id="selectedUnitDisplay" style="margin-top: 10px; display: none;">
                        <div class="alert alert-info">
                            <i class="bi bi-check-circle"></i>
                            <span id="selectedUnitText"></span>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="assignYear">Year Level *</label>
                        <select id="assignYear" required>
                            <option value="">Select Year</option>
                            <option value="1">Year 1</option>
                            <option value="2">Year 2</option>
                            <option value="3">Year 3</option>
                            <option value="4">Year 4</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="assignSemester">Semester *</label>
                        <select id="assignSemester" required>
                            <option value="">Select Semester</option>
                            <option value="1">Semester 1</option>
                            <option value="2">Semester 2</option>
                            <option value="3">Semester 3</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isMandatory" checked>
                        <label for="isMandatory" style="margin: 0;">Mandatory Unit</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAssignModal()">Cancel</button>
            <button class="btn btn-success" onclick="saveAssignment()">
                <i class="bi bi-check-circle"></i> Assign Unit
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h4>Confirm Delete</h4>
            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="deleteAlert"></div>
            <p id="deleteMessage" style="color: #64748B;">Are you sure you want to delete this item?</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmDelete()">
                <i class="bi bi-trash"></i> Delete
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let deleteCallback = null;
let searchTimeout = null;

// ========================
// UNIT CRUD FUNCTIONS
// ========================

function openUnitModal(unitId = null) {
    document.getElementById('unitForm').reset();
    document.getElementById('unitAlert').innerHTML = '';
    
    if (unitId) {
        document.getElementById('unitModalTitle').textContent = 'Edit Unit';
        loadUnitData(unitId);
    } else {
        document.getElementById('unitModalTitle').textContent = 'Create New Unit';
        document.getElementById('unitId').value = '';
    }
    
    document.getElementById('unitModal').classList.add('show');
}

function closeUnitModal() {
    document.getElementById('unitModal').classList.remove('show');
}

function loadUnitData(unitId) {
    fetch(`/admin-units/get/${unitId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('unitId').value = data.data.id;
                document.getElementById('unitCode').value = data.data.code;
                document.getElementById('unitName').value = data.data.name;
                document.getElementById('unitDescription').value = data.data.description;
                document.getElementById('creditHours').value = data.data.credit_hours;
                document.getElementById('unitDepartment').value = data.data.department_id;
                document.getElementById('isCore').checked = data.data.is_core;
                
                // Set prerequisites
                const prereqSelect = document.getElementById('unitPrerequisites');
                Array.from(prereqSelect.options).forEach(option => {
                    option.selected = data.data.prerequisites.includes(parseInt(option.value));
                });
            }
        })
        .catch(error => console.error('Error:', error));
}

function saveUnit() {
    const unitId = document.getElementById('unitId').value;
    
    // Get selected prerequisites
    const prereqSelect = document.getElementById('unitPrerequisites');
    const prerequisites = Array.from(prereqSelect.selectedOptions).map(option => parseInt(option.value));
    
    const data = {
        code: document.getElementById('unitCode').value,
        name: document.getElementById('unitName').value,
        description: document.getElementById('unitDescription').value,
        credit_hours: document.getElementById('creditHours').value,
        department_id: document.getElementById('unitDepartment').value,
        is_core: document.getElementById('isCore').checked,
        prerequisites: prerequisites
    };

    const url = unitId ? `/admin-units/${unitId}/update/` : '/admin-units/create/';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('unitAlert', 'success', data.message);
            setTimeout(() => {
                closeUnitModal();
                location.reload();
            }, 1500);
        } else {
            showAlert('unitAlert', 'danger', data.message);
        }
    })
    .catch(error => {
        showAlert('unitAlert', 'danger', 'An error occurred. Please try again.');
        console.error('Error:', error);
    });
}

function deleteUnit(unitId) {
    deleteCallback = () => {
        fetch(`/admin-units/${unitId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('deleteAlert', 'success', data.message);
                setTimeout(() => {
                    closeDeleteModal();
                    location.reload();
                }, 1500);
            } else {
                showAlert('deleteAlert', 'danger', data.message);
            }
        })
        .catch(error => {
            showAlert('deleteAlert', 'danger', 'An error occurred. Please try again.');
            console.error('Error:', error);
        });
    };
    
    document.getElementById('deleteMessage').textContent = 
        'Are you sure you want to delete this unit? This action cannot be undone.';
    document.getElementById('deleteModal').classList.add('show');
}

// ========================
// PROGRAMME UNIT FUNCTIONS
// ========================

function loadProgrammeUnits(programmeId) {
    const container = document.getElementById(`unitList${programmeId}`);
    
    fetch(`/admin-programme/${programmeId}/units/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <i class="bi bi-inbox" style="font-size: 32px;"></i>
                            <p style="margin: 10px 0 0 0; font-size: 14px;">No units assigned yet.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.data.map(unit => `
                        <div class="unit-item">
                            <div class="unit-info">
                                <div class="unit-title">
                                    <span class="unit-code">${unit.unit_code}</span>
                                    <span>${unit.unit_name}</span>
                                    ${unit.is_mandatory ? '<span class="badge badge-success">Mandatory</span>' : '<span class="badge badge-warning">Elective</span>'}
                                    ${unit.is_core ? '<span class="badge badge-info">Core</span>' : '<span class="badge badge-secondary">Elective</span>'}
                                </div>
                                <div class="unit-details">
                                    <span><i class="bi bi-building"></i> ${unit.department}</span>
                                    <span><i class="bi bi-award"></i> ${unit.credit_hours} Credits</span>
                                    <span><i class="bi bi-calendar3"></i> ${unit.year_display}</span>
                                    <span><i class="bi bi-journal"></i> ${unit.semester_display}</span>
                                </div>
                            </div>
                            <div class="unit-actions">
                                <a href="/admin-units/${unit.unit_id}/" class="btn btn-sm btn-info">
                                    <i class="bi bi-eye"></i> View
                                </a>
                                <button class="btn btn-sm btn-warning" onclick="editUnit(${unit.unit_id})">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="editAssignment(${unit.id})">
                                    <i class="bi bi-gear"></i> Config
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="removeUnitFromProgramme(${unit.id})">
                                    <i class="bi bi-x-circle"></i> Remove
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        })
        .catch(error => {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Failed to load units.
                </div>
            `;
            console.error('Error:', error);
        });
}

function editUnit(unitId) {
    openUnitModal(unitId);
}

// ========================
// ASSIGNMENT FUNCTIONS
// ========================

function openAssignModal(programmeId, programmeName) {
    document.getElementById('assignForm').reset();
    document.getElementById('assignAlert').innerHTML = '';
    document.getElementById('assignProgrammeId').value = programmeId;
    document.getElementById('assignProgrammeName').value = programmeName;
    document.getElementById('assignProgrammeUnitId').value = '';
    document.getElementById('selectedUnitId').value = '';
    document.getElementById('selectedUnitDisplay').style.display = 'none';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('searchUnit').value = '';
    
    document.getElementById('assignModalTitle').textContent = 'Assign Unit to Programme';
    document.getElementById('assignModal').classList.add('show');
}

function closeAssignModal() {
    document.getElementById('assignModal').classList.remove('show');
}

// Unit search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchUnit');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                const programmeId = document.getElementById('assignProgrammeId').value;
                searchUnits(query, programmeId);
            }, 300);
        });
    }
});

function searchUnits(query, programmeId) {
    fetch(`/admin-units/search/?q=${encodeURIComponent(query)}&programme_id=${programmeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const resultsContainer = document.getElementById('searchResults');
                if (data.data.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-item">No units found</div>';
                } else {
                    resultsContainer.innerHTML = data.data.map(unit => `
                        <div class="search-item" onclick="selectUnit(${unit.id}, '${unit.code}', '${unit.name.replace(/'/g, "\\'")}')">
                            <strong>${unit.code}</strong> - ${unit.name}
                            <br><small style="color: #64748B;">${unit.department} • ${unit.credit_hours} Credits</small>
                        </div>
                    `).join('');
                }
                resultsContainer.style.display = 'block';
            }
        })
        .catch(error => console.error('Error:', error));
}

function selectUnit(unitId, unitCode, unitName) {
    document.getElementById('selectedUnitId').value = unitId;
    document.getElementById('selectedUnitText').textContent = `${unitCode} - ${unitName}`;
    document.getElementById('selectedUnitDisplay').style.display = 'block';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('searchUnit').value = `${unitCode} - ${unitName}`;
}

function saveAssignment() {
    const programmeUnitId = document.getElementById('assignProgrammeUnitId').value;
    const programmeId = document.getElementById('assignProgrammeId').value;
    const unitId = document.getElementById('selectedUnitId').value;
    
    if (!unitId && !programmeUnitId) {
        showAlert('assignAlert', 'danger', 'Please select a unit');
        return;
    }
    
    const data = {
        unit_id: unitId,
        year_level: document.getElementById('assignYear').value,
        semester: document.getElementById('assignSemester').value,
        is_mandatory: document.getElementById('isMandatory').checked
    };

    const url = programmeUnitId 
        ? `/admin-programme-unit/${programmeUnitId}/update/`
        : `/admin-programme/${programmeId}/units/assign/`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('assignAlert', 'success', data.message);
            setTimeout(() => {
                closeAssignModal();
                loadProgrammeUnits(programmeId);
            }, 1500);
        } else {
            showAlert('assignAlert', 'danger', data.message);
        }
    })
    .catch(error => {
        showAlert('assignAlert', 'danger', 'An error occurred. Please try again.');
        console.error('Error:', error);
    });
}

function editAssignment(programmeUnitId) {
    fetch(`/admin-programme-unit/${programmeUnitId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('assignProgrammeUnitId').value = data.data.id;
                document.getElementById('assignProgrammeId').value = data.data.programme_id;
                document.getElementById('assignYear').value = data.data.year_level;
                document.getElementById('assignSemester').value = data.data.semester;
                document.getElementById('isMandatory').checked = data.data.is_mandatory;
                document.getElementById('selectedUnitId').value = data.data.unit_id;
                
                // Hide search, show selected unit
                document.getElementById('searchUnit').parentElement.parentElement.style.display = 'none';
                
                document.getElementById('assignModalTitle').textContent = 'Edit Unit Assignment';
                document.getElementById('assignModal').classList.add('show');
            }
        })
        .catch(error => console.error('Error:', error));
}

function removeUnitFromProgramme(programmeUnitId) {
    deleteCallback = () => {
        fetch(`/admin-programme-unit/${programmeUnitId}/remove/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('deleteAlert', 'success', data.message);
                setTimeout(() => {
                    closeDeleteModal();
                    location.reload();
                }, 1500);
            } else {
                showAlert('deleteAlert', 'danger', data.message);
            }
        })
        .catch(error => {
            showAlert('deleteAlert', 'danger', 'An error occurred. Please try again.');
            console.error('Error:', error);
        });
    };
    
    document.getElementById('deleteMessage').textContent = 
        'Are you sure you want to remove this unit from the programme?';
    document.getElementById('deleteModal').classList.add('show');
}

// ========================
// UTILITY FUNCTIONS
// ========================

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('show');
    document.getElementById('deleteAlert').innerHTML = '';
    deleteCallback = null;
}

function confirmDelete() {
    if (deleteCallback) {
        deleteCallback();
    }
}

function showAlert(containerId, type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'danger' ? 'alert-danger' : 'alert-info';
    const icon = type === 'success' ? 'check-circle' : 
                 type === 'danger' ? 'exclamation-triangle' : 'info-circle';
    
    document.getElementById(containerId).innerHTML = `
        <div class="alert ${alertClass}">
            <i class="bi bi-${icon}"></i>
            ${message}
        </div>
    `;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Load programme units on page load
document.addEventListener('DOMContentLoaded', function() {
    {% for programme in programmes %}
    loadProgrammeUnits({{ programme.id }});
    {% endfor %}
});

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('show');
    }
}
</script>
{% endblock %}