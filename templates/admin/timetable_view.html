{% extends 'admin_base.html' %}

{% block title %}View Timetable{% endblock %}

{% block page_title %}View Timetable{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
    .breadcrumb {
        padding: 0;
        margin-bottom: 20px;
        font-size: 14px;
        list-style: none;
        display: flex;
        flex-wrap: wrap;
    }

    .breadcrumb-item {
        color: #64748B;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "/ ";
        color: #94A3B8;
        padding: 0 8px;
    }

    .breadcrumb-item.active {
        color: #1E293B;
        font-weight: 500;
    }

    .breadcrumb a {
        color: #4F46E5;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        color: #4338CA;
    }

    .section-container {
        background: white;
        border-radius: 5px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
        border: 1px solid #f0f0f0;
    }

    .control-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .form-group label {
        font-size: 13px;
        font-weight: 600;
        color: #475569;
    }

    .form-group select {
        padding: 10px;
        border: 1px solid #E2E8F0;
        border-radius: 5px;
        font-size: 14px;
        background: white;
        color: #1E293B;
    }

    .form-group select:focus {
        outline: none;
        border-color: #4F46E5;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
    }

    .btn-primary {
        background: #4F46E5;
        color: white;
    }

    .btn-primary:hover {
        background: #4338CA;
    }

    .btn-success {
        background: #10B981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-secondary {
        background: #64748B;
        color: white;
    }

    .btn-secondary:hover {
        background: #475569;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .timetable-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
    }

    .timetable-header h2 {
        margin: 0 0 5px 0;
        font-size: 24px;
    }

    .timetable-header p {
        margin: 5px 0;
        font-size: 14px;
        opacity: 0.95;
    }

    .timetable-container {
        overflow-x: auto;
        background: white;
        border-radius: 5px;
        border: 1px solid #E2E8F0;
    }

    .timetable-grid {
        display: grid;
        grid-template-columns: 120px repeat(6, 1fr);
        min-width: 1000px;
    }

    .time-label {
        padding: 15px 10px;
        background: #F8FAFC;
        border-bottom: 1px solid #E2E8F0;
        border-right: 1px solid #E2E8F0;
        font-size: 13px;
        font-weight: 600;
        color: #475569;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .day-header {
        padding: 15px;
        background: #4F46E5;
        color: white;
        text-align: center;
        font-weight: 600;
        font-size: 14px;
        border-bottom: 1px solid #4338CA;
    }

    .timetable-cell {
        min-height: 80px;
        border-bottom: 1px solid #E2E8F0;
        border-right: 1px solid #E2E8F0;
        padding: 8px;
        background: white;
    }

    .timetable-cell.empty {
        background: #FAFAFA;
    }

    .class-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 5px;
        padding: 10px;
        height: 100%;
        font-size: 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .class-code {
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 4px;
    }

    .class-name {
        font-size: 11px;
        opacity: 0.95;
        margin-bottom: 6px;
        line-height: 1.3;
    }

    .class-details {
        font-size: 11px;
        opacity: 0.9;
    }

    .class-detail-item {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-bottom: 2px;
    }

    .alert {
        padding: 12px 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
    }

    .alert-info {
        background: #DBEAFE;
        color: #1E3A8A;
        border-left: 4px solid #3B82F6;
    }

    .alert-warning {
        background: #FEF3C7;
        color: #92400E;
        border-left: 4px solid #F59E0B;
    }

    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
        color: #64748B;
    }

    .loading-spinner.show {
        display: block;
    }

    .loading-spinner i {
        font-size: 32px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #64748B;
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        color: #CBD5E1;
    }

    .empty-state h3 {
        font-size: 20px;
        color: #475569;
        margin-bottom: 10px;
    }

    .empty-state p {
        font-size: 14px;
    }

    .print-btn {
        background: #6366F1;
        color: white;
    }

    .print-btn:hover {
        background: #4F46E5;
    }

    @media print {
        .no-print {
            display: none !important;
        }
        
        .section-container {
            box-shadow: none;
            border: none;
        }
        
        .timetable-grid {
            min-width: 100%;
        }
    }

    @media (max-width: 768px) {
        .control-panel {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="no-print">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class="bi bi-house-door"></i> Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">View Timetable</li>
    </ol>
</nav>

<!-- Control Panel -->
<div class="section-container no-print">
    <div class="control-panel">
        <div class="form-group">
            <label for="semester"><i class="bi bi-calendar3"></i> Semester</label>
            <select id="semester" required>
                <option value="">Select Semester</option>
                {% for semester in semesters %}
                <option value="{{ semester.id }}" {% if semester.is_current %}selected{% endif %}>
                    {{ semester }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="programme"><i class="bi bi-book"></i> Programme</label>
            <select id="programme" required>
                <option value="">Select Programme</option>
                {% for programme in programmes %}
                <option value="{{ programme.id }}" data-code="{{ programme.code }}" data-name="{{ programme.name }}">
                    {{ programme.code }} - {{ programme.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="yearLevel"><i class="bi bi-mortarboard"></i> Year Level</label>
            <select id="yearLevel" required>
                <option value="">Select Year</option>
                {% for year in year_levels %}
                <option value="{{ year }}">Year {{ year }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="align-self: flex-end;">
            <button type="button" id="loadTimetable" class="btn btn-primary">
                <i class="bi bi-eye"></i> View Timetable
            </button>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div id="actionBar" class="section-container no-print" style="display: none;">
    <div class="action-buttons">
        <button type="button" id="exportExcel" class="btn btn-success">
            <i class="bi bi-file-earmark-excel"></i> Export to Excel
        </button>
        <button type="button" onclick="window.print()" class="btn print-btn">
            <i class="bi bi-printer"></i> Print Timetable
        </button>
        <button type="button" onclick="clearTimetable()" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Clear
        </button>
    </div>
</div>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner">
    <i class="bi bi-hourglass-split"></i>
    <p style="margin-top: 10px;">Loading timetable...</p>
</div>

<!-- Empty State -->
<div id="emptyState" class="section-container">
    <div class="empty-state">
        <i class="bi bi-calendar-week"></i>
        <h3>No Timetable Selected</h3>
        <p>Please select a semester, programme, and year level to view the timetable</p>
    </div>
</div>

<!-- Timetable Display -->
<div id="timetableDisplay" style="display: none;">
    <!-- Timetable Header -->
    <div class="timetable-header" id="timetableHeaderInfo">
        <h2>FACULTY OF BUSINESS - TIMETABLE</h2>
        <p id="programmeInfo"></p>
        <p id="semesterYearInfo"></p>
    </div>

    <!-- Timetable Grid -->
    <div class="section-container">
        <div class="timetable-container">
            <div class="timetable-grid" id="timetableGrid">
                <!-- Header Row -->
                <div class="time-label">Time</div>
                {% for day in days_of_week %}
                <div class="day-header">{{ day|title }}</div>
                {% endfor %}

                <!-- Time Slots -->
                {% for slot in time_slots %}
                <div class="time-label">{{ slot.label }}</div>
                {% for day in days_of_week %}
                <div class="timetable-cell empty" data-day="{{ day }}" data-time="{{ slot.start }}">
                    <!-- Classes will be dynamically inserted here -->
                </div>
                {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let currentProgrammeId = null;
    let currentYearLevel = null;
    let currentSemesterId = null;

    document.getElementById('loadTimetable').addEventListener('click', function() {
        const semesterId = document.getElementById('semester').value;
        const programmeId = document.getElementById('programme').value;
        const yearLevel = document.getElementById('yearLevel').value;

        if (!semesterId || !programmeId || !yearLevel) {
            alert('Please select all fields to view the timetable.');
            return;
        }

        // Store current selections
        currentProgrammeId = programmeId;
        currentYearLevel = yearLevel;
        currentSemesterId = semesterId;

        // Show loading spinner
        document.getElementById('loadingSpinner').classList.add('show');
        document.getElementById('timetableDisplay').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('actionBar').style.display = 'none';

        // Fetch timetable data via AJAX
        fetch(`/admin-timetable/get-data/${programmeId}/${yearLevel}/${semesterId}/`)
            .then(response => response.json())
            .then(data => {
                // Hide loading spinner
                document.getElementById('loadingSpinner').classList.remove('show');

                if (!data.success) {
                    alert('Error loading timetable: ' + data.error);
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                // Check if timetable is empty
                let hasClasses = false;
                for (let day in data.timetable) {
                    for (let time in data.timetable[day]) {
                        if (data.timetable[day][time]) {
                            hasClasses = true;
                            break;
                        }
                    }
                    if (hasClasses) break;
                }

                if (!hasClasses) {
                    alert('No timetable entries found for the selected criteria.');
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                // Populate timetable header info
                document.getElementById('programmeInfo').innerText = 
                    `${data.programme.code} - ${data.programme.name} (Year ${data.year_level})`;
                document.getElementById('semesterYearInfo').innerText = `${data.semester}`;

                // Clear existing timetable cells
                const cells = document.querySelectorAll('.timetable-cell');
                cells.forEach(cell => {
                    cell.innerHTML = '';
                    cell.classList.add('empty');
                });

                // Populate timetable cells with classes
                for (let day in data.timetable) {
                    for (let time in data.timetable[day]) {
                        const classInfo = data.timetable[day][time];
                        if (classInfo) {
                            const cellSelector = `.timetable-cell[data-day="${day}"][data-time="${time}"]`;
                            const cell = document.querySelector(cellSelector);
                            if (cell) {
                                cell.classList.remove('empty');
                                cell.innerHTML = `
                                    <div class="class-info">
                                        <div class="class-code">${classInfo.unit_code}</div>
                                        <div class="class-name">${classInfo.unit_name}</div>
                                        <div class="class-details">
                                            <div class="class-detail-item">
                                                <i class="bi bi-person-fill"></i> ${classInfo.lecturer_name}
                                            </div>
                                            <div class="class-detail-item">
                                                <i class="bi bi-geo-alt-fill"></i> ${classInfo.venue_code} - ${classInfo.venue_name}
                                            </div>
                                            <div class="class-detail-item">
                                                <i class="bi bi-clock-fill"></i> ${classInfo.start_time} - ${classInfo.end_time}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    }
                }

                // Show timetable display and action bar
                document.getElementById('timetableDisplay').style.display = 'block';
                document.getElementById('actionBar').style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching timetable:', error);
                alert('An error occurred while fetching the timetable. Please try again.');
                document.getElementById('loadingSpinner').classList.remove('show');
                document.getElementById('emptyState').style.display = 'block';
            });
    });

    function clearTimetable() {
        document.getElementById('timetableDisplay').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('actionBar').style.display = 'none';
        document.getElementById('semester').value = '';
        document.getElementById('programme').value = '';
        document.getElementById('yearLevel').value = '';
        currentProgrammeId = null;
        currentYearLevel = null;
        currentSemesterId = null;
    }

    document.getElementById('exportExcel').addEventListener('click', function() {
        if (!currentProgrammeId || !currentYearLevel || !currentSemesterId) {
            alert('Please load a timetable first.');
            return;
        }

        // Redirect to Excel export URL
        window.location.href = `/admin-timetable/export-excel/?programme_id=${currentProgrammeId}&year_level=${currentYearLevel}&semester_id=${currentSemesterId}`;
    });
</script>
{% endblock %}