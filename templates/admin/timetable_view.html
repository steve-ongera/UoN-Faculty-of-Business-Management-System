{% extends 'admin_base.html' %}
{% load static %}
{% block title %}View Timetable{% endblock %}

{% block page_title %}View Timetable{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<link rel='stylesheet' href='{% static 'css/timetable_view.css' %}'>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="no-print">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class="bi bi-house-door"></i> Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">View Timetable</li>
    </ol>
</nav>

<!-- Control Panel -->
<div class="section-container no-print">
    <div class="control-panel">
        <div class="form-group">
            <label for="semester"><i class="bi bi-calendar3"></i> Semester</label>
            <select id="semester" required>
                <option value="">Select Semester</option>
                {% for semester in semesters %}
                <option value="{{ semester.id }}" {% if semester.is_current %}selected{% endif %}>
                    {{ semester }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="programme"><i class="bi bi-book"></i> Programme</label>
            <select id="programme" required>
                <option value="">Select Programme</option>
                {% for programme in programmes %}
                <option value="{{ programme.id }}" data-code="{{ programme.code }}" data-name="{{ programme.name }}">
                    {{ programme.code }} - {{ programme.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="yearLevel"><i class="bi bi-mortarboard"></i> Year Level</label>
            <select id="yearLevel" required>
                <option value="">Select Year</option>
                {% for year in year_levels %}
                <option value="{{ year }}">Year {{ year }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="align-self: flex-end;">
            <button type="button" id="loadTimetable" class="btn btn-primary">
                <i class="bi bi-eye"></i> View Timetable
            </button>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div id="actionBar" class="section-container no-print" style="display: none;">
    <div class="action-buttons">
        <button type="button" id="exportExcel" class="btn btn-success">
            <i class="bi bi-file-earmark-excel"></i> Export to Excel
        </button>
        <button type="button" onclick="window.print()" class="btn print-btn">
            <i class="bi bi-printer"></i> Print Timetable
        </button>
        <button type="button" onclick="clearTimetable()" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Clear
        </button>
    </div>
</div>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner">
    <i class="bi bi-hourglass-split"></i>
    <p style="margin-top: 10px;">Loading timetable...</p>
</div>

<!-- Empty State -->
<div id="emptyState" class="section-container">
    <div class="empty-state">
        <i class="bi bi-calendar-week"></i>
        <h3>No Timetable Selected</h3>
        <p>Please select a semester, programme, and year level to view the timetable</p>
    </div>
</div>

<!-- Timetable Display -->
<div id="timetableDisplay" style="display: none;">
    <!-- Timetable Header -->
    <div class="timetable-header" id="timetableHeaderInfo">
        <h2>FACULTY OF BUSINESS - TIMETABLE</h2>
        <p id="programmeInfo"></p>
        <p id="semesterYearInfo"></p>
    </div>

    <!-- Timetable Grid -->
    <div class="section-container">
        <div class="timetable-container">
            <div class="timetable-grid" id="timetableGrid">
                <!-- Header Row -->
                <div class="time-label">Time</div>
                {% for day in days_of_week %}
                <div class="day-header">{{ day|title }}</div>
                {% endfor %}

                <!-- Time Slots -->
                {% for slot in time_slots %}
                <div class="time-label">{{ slot.label }}</div>
                {% for day in days_of_week %}
                <div class="timetable-cell empty" data-day="{{ day }}" data-time="{{ slot.start }}">
                    <!-- Classes will be dynamically inserted here -->
                </div>
                {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let currentProgrammeId = null;
    let currentYearLevel = null;
    let currentSemesterId = null;

    document.getElementById('loadTimetable').addEventListener('click', function() {
        const semesterId = document.getElementById('semester').value;
        const programmeId = document.getElementById('programme').value;
        const yearLevel = document.getElementById('yearLevel').value;

        if (!semesterId || !programmeId || !yearLevel) {
            alert('Please select all fields to view the timetable.');
            return;
        }

        // Store current selections
        currentProgrammeId = programmeId;
        currentYearLevel = yearLevel;
        currentSemesterId = semesterId;

        // Show loading spinner
        document.getElementById('loadingSpinner').classList.add('show');
        document.getElementById('timetableDisplay').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('actionBar').style.display = 'none';

        // Fetch timetable data via AJAX
        fetch(`/admin-timetable/get-data/${programmeId}/${yearLevel}/${semesterId}/`)
            .then(response => response.json())
            .then(data => {
                // Hide loading spinner
                document.getElementById('loadingSpinner').classList.remove('show');

                if (!data.success) {
                    alert('Error loading timetable: ' + data.error);
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                // Check if timetable is empty
                let hasClasses = false;
                for (let day in data.timetable) {
                    for (let time in data.timetable[day]) {
                        if (data.timetable[day][time]) {
                            hasClasses = true;
                            break;
                        }
                    }
                    if (hasClasses) break;
                }

                if (!hasClasses) {
                    alert('No timetable entries found for the selected criteria.');
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                // Populate timetable header info
                document.getElementById('programmeInfo').innerText = 
                    `${data.programme.code} - ${data.programme.name} (Year ${data.year_level})`;
                document.getElementById('semesterYearInfo').innerText = `${data.semester}`;

                // Clear existing timetable cells
                const cells = document.querySelectorAll('.timetable-cell');
                cells.forEach(cell => {
                    cell.innerHTML = '';
                    cell.classList.add('empty');
                });

                // Populate timetable cells with classes
                for (let day in data.timetable) {
                    for (let time in data.timetable[day]) {
                        const classInfo = data.timetable[day][time];
                        if (classInfo) {
                            const cellSelector = `.timetable-cell[data-day="${day}"][data-time="${time}"]`;
                            const cell = document.querySelector(cellSelector);
                            if (cell) {
                                cell.classList.remove('empty');
                                cell.innerHTML = `
                                    <div class="class-info">
                                        <div class="class-code">${classInfo.unit_code}</div>
                                        <div class="class-name">${classInfo.unit_name}</div>
                                        <div class="class-details">
                                            <div class="class-detail-item">
                                                <i class="bi bi-person-fill"></i> ${classInfo.lecturer_name}
                                            </div>
                                            <div class="class-detail-item">
                                                <i class="bi bi-geo-alt-fill"></i> ${classInfo.venue_code} - ${classInfo.venue_name}
                                            </div>
                                            <div class="class-detail-item">
                                                <i class="bi bi-clock-fill"></i> ${classInfo.start_time} - ${classInfo.end_time}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    }
                }

                // Show timetable display and action bar
                document.getElementById('timetableDisplay').style.display = 'block';
                document.getElementById('actionBar').style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching timetable:', error);
                alert('An error occurred while fetching the timetable. Please try again.');
                document.getElementById('loadingSpinner').classList.remove('show');
                document.getElementById('emptyState').style.display = 'block';
            });
    });

    function clearTimetable() {
        document.getElementById('timetableDisplay').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('actionBar').style.display = 'none';
        document.getElementById('semester').value = '';
        document.getElementById('programme').value = '';
        document.getElementById('yearLevel').value = '';
        currentProgrammeId = null;
        currentYearLevel = null;
        currentSemesterId = null;
    }

    document.getElementById('exportExcel').addEventListener('click', function() {
        if (!currentProgrammeId || !currentYearLevel || !currentSemesterId) {
            alert('Please load a timetable first.');
            return;
        }

        // Redirect to Excel export URL
        window.location.href = `/admin-timetable/export-excel/?programme_id=${currentProgrammeId}&year_level=${currentYearLevel}&semester_id=${currentSemesterId}`;
    });
</script>
{% endblock %}
