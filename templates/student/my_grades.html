{% extends 'student_base.html' %}

{% block title %}My Grades - Faculty Management System{% endblock %}

{% block page_title %}My Academic Grades{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
    .breadcrumb {
        padding: 0;
        margin-bottom: 20px;
        font-size: 14px;
        list-style: none;
        display: flex;
        flex-wrap: wrap;
    }

    .breadcrumb-item {
        color: #64748B;
        position: relative;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "/ ";
        color: #94A3B8;
        padding: 0 8px;
    }

    .breadcrumb-item.active {
        color: #1E293B;
        font-weight: 500;
    }

    .breadcrumb a {
        color: #4F46E5;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .breadcrumb a:hover {
        color: #4338CA;
    }

    .section-container {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        border: 1px solid #f0f0f0;
    }

    .header-section {
        margin-bottom: 30px;
        padding-bottom: 24px;
        border-bottom: 2px solid #F1F5F9;
    }

    .header-title {
        font-size: 24px;
        font-weight: 700;
        color: #1E293B;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .header-title i {
        color: #4F46E5;
        font-size: 28px;
    }

    .programme-info {
        font-size: 15px;
        color: #64748B;
        margin-bottom: 16px;
    }

    .programme-info strong {
        color: #1E293B;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
    }

    .stat-card {
        background: linear-gradient(135deg, #F0F9FF 0%, #F5F3FF 100%);
        border: 2px solid #E0E7FF;
        border-radius: 8px;
        padding: 16px;
    }

    .stat-label {
        font-size: 12px;
        font-weight: 600;
        color: #64748B;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #4F46E5;
    }

    .stat-sub {
        font-size: 11px;
        color: #94A3B8;
        margin-top: 4px;
    }

    /* GPA Highlight */
    .gpa-highlight {
        background: linear-gradient(135deg, #4F46E5, #7C3AED);
        color: white;
        border-color: #4F46E5;
    }

    .gpa-highlight .stat-label {
        color: rgba(255, 255, 255, 0.9);
    }

    .gpa-highlight .stat-value {
        color: white;
        font-size: 32px;
    }

    .gpa-highlight .stat-sub {
        color: rgba(255, 255, 255, 0.8);
    }

    /* Classification Badge */
    .classification-badge {
        display: inline-block;
        padding: 8px 16px;
        background: linear-gradient(135deg, #10B981, #059669);
        color: white;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 700;
        margin-top: 8px;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Year Tabs */
    .year-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #F1F5F9;
        overflow-x: auto;
    }

    .year-tab {
        padding: 10px 20px;
        background: #F1F5F9;
        border: 2px solid #E2E8F0;
        border-radius: 6px;
        color: #64748B;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .year-tab:hover {
        border-color: #4F46E5;
        color: #4F46E5;
    }

    .year-tab.active {
        background: linear-gradient(135deg, #4F46E5, #7C3AED);
        color: white;
        border-color: #4F46E5;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
    }

    .year-content {
        display: none;
    }

    .year-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Academic Year Section */
    .academic-year-section {
        margin-bottom: 32px;
        border: 2px solid #E0E7FF;
        border-radius: 8px;
        overflow: hidden;
    }

    .academic-year-header {
        background: linear-gradient(135deg, #EEF2FF 0%, #F5F3FF 100%);
        padding: 16px 20px;
        border-bottom: 2px solid #E0E7FF;
    }

    .academic-year-title {
        font-size: 18px;
        font-weight: 700;
        color: #4F46E5;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .academic-year-content {
        padding: 20px;
    }

    /* Semester Tabs */
    .semester-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        overflow-x: auto;
        padding-bottom: 8px;
    }

    .semester-tab {
        padding: 8px 16px;
        background: #F8FAFC;
        border: 2px solid #E2E8F0;
        border-radius: 6px;
        color: #64748B;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.3s ease;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .semester-tab:hover {
        border-color: #7C3AED;
        color: #7C3AED;
    }

    .semester-tab.active {
        background: #7C3AED;
        color: white;
        border-color: #7C3AED;
        box-shadow: 0 4px 12px rgba(124, 58, 237, 0.2);
    }

    .semester-content {
        display: none;
    }

    .semester-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    .semester-header {
        background: linear-gradient(135deg, #F0F9FF 0%, #F5F3FF 100%);
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        border-left: 4px solid #7C3AED;
    }

    .semester-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
    }

    .semester-title {
        font-size: 15px;
        font-weight: 700;
        color: #1E293B;
    }

    .semester-stats {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
    }

    .semester-stat {
        background: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        color: #7C3AED;
    }

    /* Units Table */
    .units-table-container {
        overflow-x: auto;
    }

    .units-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    .units-table thead {
        background: #F8FAFC;
    }

    .units-table th {
        padding: 12px;
        text-align: left;
        font-size: 12px;
        font-weight: 700;
        color: #64748B;
        text-transform: uppercase;
        border-bottom: 2px solid #E2E8F0;
    }

    .units-table td {
        padding: 16px 12px;
        border-bottom: 1px solid #F1F5F9;
        font-size: 14px;
        color: #1E293B;
    }

    .units-table tbody tr:hover {
        background: #F8FAFC;
    }

    .unit-code {
        font-weight: 700;
        color: #4F46E5;
        font-size: 13px;
    }

    .unit-name {
        color: #1E293B;
        font-weight: 500;
    }

    .grade-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 14px;
        min-width: 45px;
        text-align: center;
    }

    .grade-A { background: #DCFCE7; color: #166534; }
    .grade-B { background: #DBEAFE; color: #1E40AF; }
    .grade-C { background: #FEF3C7; color: #92400E; }
    .grade-D { background: #FED7AA; color: #9A3412; }
    .grade-F { background: #FEE2E2; color: #991B1B; }

    .gp-badge {
        display: inline-block;
        padding: 4px 10px;
        background: #F5F3FF;
        border: 1px solid #E9D5FF;
        border-radius: 4px;
        font-weight: 600;
        font-size: 13px;
        color: #7C3AED;
    }

    /* Assessment Breakdown */
    .assessment-breakdown {
        margin-top: 8px;
    }

    .assessment-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        font-size: 12px;
        color: #64748B;
    }

    .assessment-name {
        font-weight: 600;
    }

    .assessment-marks {
        color: #4F46E5;
        font-weight: 600;
    }

    .expand-btn {
        background: none;
        border: none;
        color: #4F46E5;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        padding: 4px 8px;
        transition: all 0.3s ease;
    }

    .expand-btn:hover {
        color: #4338CA;
        text-decoration: underline;
    }

    .expand-btn i {
        transition: transform 0.3s ease;
    }

    .expand-btn.expanded i {
        transform: rotate(180deg);
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }

    .empty-icon {
        font-size: 48px;
        color: #CBD5E1;
        margin-bottom: 12px;
    }

    .empty-title {
        font-size: 16px;
        font-weight: 600;
        color: #64748B;
        margin-bottom: 8px;
    }

    .empty-text {
        font-size: 14px;
        color: #94A3B8;
    }

    @media (max-width: 768px) {
        .section-container {
            padding: 20px;
        }

        .header-title {
            font-size: 20px;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .units-table {
            font-size: 12px;
        }

        .units-table th,
        .units-table td {
            padding: 10px 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'student_dashboard' %}"><i class="bi bi-house-door"></i> Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">My Grades</li>
    </ol>
</nav>

<div class="section-container">
    <!-- Header -->
    <div class="header-section">
        <h1 class="header-title">
            <i class="bi bi-trophy"></i> My Academic Grades
        </h1>
        <div class="programme-info">
            <strong>{{ programme.name }}</strong> ({{ programme.code }})
            <br>
            <span style="font-size: 13px;">{{ student.registration_number }} • {{ programme.get_level_display }}</span>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card gpa-highlight">
                <div class="stat-label">
                    <i class="bi bi-star-fill"></i> Cumulative GPA
                </div>
                <div class="stat-value">{{ cumulative_gpa }}</div>
                <div class="stat-sub">out of 4.00</div>
                <div class="classification-badge">
                    <i class="bi bi-award"></i> {{ classification }}
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <i class="bi bi-book-fill"></i> Units Completed
                </div>
                <div class="stat-value">{{ total_units_completed }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <i class="bi bi-mortarboard"></i> Credits Earned
                </div>
                <div class="stat-value">{{ total_credits_earned }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <i class="bi bi-calendar-range"></i> Current Year
                </div>
                <div class="stat-value">{{ current_year }}</div>
                <div class="stat-sub">Year {{ current_year }}</div>
            </div>
        </div>
    </div>

    <!-- Year Tabs -->
    {% if grades_by_year %}
    <div class="year-tabs">
        {% for year_data in grades_by_year %}
        <button 
            type="button" 
            class="year-tab {% if forloop.first %}active{% endif %}"
            onclick="switchYear(this, 'year-{{ year_data.year_level }}')">
            <i class="bi bi-bookmark"></i> {{ year_data.year_label }}
        </button>
        {% endfor %}
    </div>

    <!-- Year Contents -->
    {% for year_data in grades_by_year %}
    <div id="year-{{ year_data.year_level }}" class="year-content {% if forloop.first %}active{% endif %}">
        
        <!-- Academic Years within this Year Level -->
        {% for academic_year_data in year_data.academic_years %}
        <div class="academic-year-section">
            <div class="academic-year-header">
                <div class="academic-year-title">
                    <i class="bi bi-calendar3"></i>
                    Academic Year: {{ academic_year_data.year_code }}
                </div>
            </div>
            
            <div class="academic-year-content">
                <!-- Semester Tabs -->
                <div class="semester-tabs">
                    {% for semester_data in academic_year_data.semesters %}
                    <button 
                        type="button" 
                        class="semester-tab {% if forloop.first %}active{% endif %}"
                        onclick="switchSemester(this, 'sem-{{ year_data.year_level }}-{{ academic_year_data.academic_year.id }}-{{ semester_data.semester_num }}')">
                        <i class="bi bi-hourglass-split"></i> {{ semester_data.semester_label }}
                    </button>
                    {% endfor %}
                </div>

                <!-- Semester Contents -->
                {% for semester_data in academic_year_data.semesters %}
                <div id="sem-{{ year_data.year_level }}-{{ academic_year_data.academic_year.id }}-{{ semester_data.semester_num }}" 
                     class="semester-content {% if forloop.first %}active{% endif %}">
                    
                    <!-- Semester Header -->
                    <div class="semester-header">
                        <div class="semester-info">
                            <span class="semester-title">
                                <i class="bi bi-hourglass-split"></i> {{ semester_data.semester_label }}
                            </span>
                            <div class="semester-stats">
                                <span class="semester-stat">
                                    <i class="bi bi-star"></i> GPA: {{ semester_data.semester_gpa }}
                                </span>
                                <span class="semester-stat">
                                    <i class="bi bi-book"></i> {{ semester_data.total_units }} Units
                                </span>
                                <span class="semester-stat">
                                    <i class="bi bi-mortarboard"></i> {{ semester_data.total_credits }} Credits
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Units Table -->
                    {% if semester_data.units %}
                    <div class="units-table-container">
                        <table class="units-table">
                            <thead>
                                <tr>
                                    <th>Unit Code</th>
                                    <th>Unit Name</th>
                                    <th>Credits</th>
                                    <th>Total Marks</th>
                                    <th>Grade</th>
                                    <th>Grade Point</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for unit in semester_data.units %}
                                <tr>
                                    <td>
                                        <span class="unit-code">{{ unit.unit_code }}</span>
                                    </td>
                                    <td>
                                        <span class="unit-name">{{ unit.unit_name }}</span>
                                    </td>
                                    <td>{{ unit.credit_hours }}</td>
                                    <td>
                                        <strong>{{ unit.total_marks|floatformat:2 }}%</strong>
                                    </td>
                                    <td>
                                        {% if unit.has_grade %}
                                        <span class="grade-badge grade-{{ unit.grade }}">
                                            {{ unit.grade }}
                                        </span>
                                        {% else %}
                                        <span style="color: #94A3B8; font-style: italic;">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if unit.has_grade %}
                                        <span class="gp-badge">{{ unit.grade_point }}</span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if unit.assessment_breakdown %}
                                        <button 
                                            class="expand-btn" 
                                            onclick="toggleAssessment(this, 'assessment-{{ year_data.year_level }}-{{ academic_year_data.academic_year.id }}-{{ semester_data.semester_num }}-{{ forloop.counter }}')"
                                            type="button">
                                            <i class="bi bi-chevron-down"></i> View Breakdown
                                        </button>
                                        {% else %}
                                        <span style="color: #94A3B8;">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if unit.assessment_breakdown %}
                                <tr id="assessment-{{ year_data.year_level }}-{{ academic_year_data.academic_year.id }}-{{ semester_data.semester_num }}-{{ forloop.counter }}" style="display: none;">
                                    <td colspan="7" style="background: #F8FAFC; padding: 16px;">
                                        <div class="assessment-breakdown">
                                            <strong style="font-size: 13px; color: #1E293B; display: block; margin-bottom: 8px;">
                                                <i class="bi bi-file-earmark-text"></i> Assessment Breakdown
                                            </strong>
                                            {% for assessment in unit.assessment_breakdown %}
                                            <div class="assessment-item">
                                                <span class="assessment-name">
                                                    {{ assessment.name }} ({{ assessment.type }}) - {{ assessment.weight }}%
                                                </span>
                                                <span class="assessment-marks">
                                                    {{ assessment.marks_obtained|floatformat:1 }}/{{ assessment.max_marks|floatformat:0 }}
                                                    ({{ assessment.percentage|floatformat:1 }}%) = 
                                                    <strong>{{ assessment.weighted_marks|floatformat:2 }}%</strong>
                                                </span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="bi bi-inbox"></i>
                        </div>
                        <h3 class="empty-title">No Grades Available</h3>
                        <p class="empty-text">No grades have been posted for this semester yet.</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endfor %}

    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="bi bi-inbox"></i>
        </div>
        <h3 class="empty-title">No Grades Available</h3>
        <p class="empty-text">You don't have any completed units with grades yet.</p>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    function switchYear(element, yearId) {
        const tabs = element.parentElement.querySelectorAll('.year-tab');
        const yearContents = document.querySelectorAll('.year-content');
        
        tabs.forEach(tab => tab.classList.remove('active'));
        yearContents.forEach(content => content.classList.remove('active'));
        
        element.classList.add('active');
        document.getElementById(yearId).classList.add('active');
        
        // Activate first semester of first academic year in this year level
        const firstSemesterTab = document.querySelector(`#${yearId} .semester-tab`);
        if (firstSemesterTab) {
            firstSemesterTab.click();
        }
    }

    function switchSemester(element, semesterId) {
        const parentAcademicYear = element.closest('.academic-year-content');
        const tabs = parentAcademicYear.querySelectorAll('.semester-tab');
        const contents = parentAcademicYear.querySelectorAll('.semester-content');
        
        tabs.forEach(tab => tab.classList.remove('active'));
        contents.forEach(content => content.classList.remove('active'));
        
        element.classList.add('active');
        document.getElementById(semesterId).classList.add('active');
    }

    function toggleAssessment(button, assessmentId) {
        const row = document.getElementById(assessmentId);
        const icon = button.querySelector('i');
        
        if (row.style.display === 'none') {
            row.style.display = 'table-row';
            button.classList.add('expanded');
            button.innerHTML = '<i class="bi bi-chevron-up"></i> Hide Breakdown';
        } else {
            row.style.display = 'none';
            button.classList.remove('expanded');
            button.innerHTML = '<i class="bi bi-chevron-down"></i> View Breakdown';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const firstYearTab = document.querySelector('.year-tab.active');
        if (firstYearTab) {
            // Trigger click to ensure proper initialization
            const yearId = firstYearTab.getAttribute('onclick').match(/'([^']+)'/)[1];
            const firstSemesterTab = document.querySelector(`#${yearId} .semester-tab`);
            if (firstSemesterTab) {
                firstSemesterTab.click();
            }
        }
    });
</script>
{% endblock %}