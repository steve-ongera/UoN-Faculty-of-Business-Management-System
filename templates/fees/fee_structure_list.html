{% extends 'admin_base.html' %}
{% load custom_filters %}
{% block title %}Fee Structure Management{% endblock %}

{% block page_title %}Fee Structure Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
    .breadcrumb {
        padding: 0;
        margin-bottom: 20px;
        font-size: 14px;
        list-style: none;
        display: flex;
        flex-wrap: wrap;
    }

    .breadcrumb-item {
        color: #64748B;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "/ ";
        color: #94A3B8;
        padding: 0 8px;
    }

    .breadcrumb-item.active {
        color: #1E293B;
        font-weight: 500;
    }

    .breadcrumb a {
        color: #4F46E5;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        color: #4338CA;
    }

    .section-container {
        background: white;
        border-radius: 5px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
        border: 1px solid #f0f0f0;
    }

    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
    }

    .btn-primary {
        background: #4F46E5;
        color: white;
    }

    .btn-primary:hover {
        background: #4338CA;
    }

    .btn-secondary {
        background: #64748B;
        color: white;
    }

    .btn-warning {
        background: #F59E0B;
        color: white;
    }

    .btn-danger {
        background: #EF4444;
        color: white;
    }

    .filters-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-size: 13px;
        font-weight: 600;
        color: #64748B;
    }

    .filter-group select {
        padding: 8px 12px;
        border: 1px solid #E2E8F0;
        border-radius: 5px;
        font-size: 14px;
        min-width: 200px;
    }

    .tabs-container {
        margin-top: 20px;
    }

    .tabs-nav {
        display: flex;
        gap: 10px;
        border-bottom: 2px solid #E2E8F0;
        margin-bottom: 20px;
        overflow-x: auto;
    }

    .tab-btn {
        padding: 12px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #64748B;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .tab-btn:hover {
        color: #4F46E5;
    }

    .tab-btn.active {
        color: #4F46E5;
        border-bottom-color: #4F46E5;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .year-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        background: #F8FAFC;
        padding: 10px;
        border-radius: 5px;
    }

    .year-tab {
        padding: 8px 16px;
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #64748B;
        transition: all 0.3s ease;
    }

    .year-tab:hover {
        color: #4F46E5;
        border-color: #4F46E5;
    }

    .year-tab.active {
        background: #4F46E5;
        color: white;
        border-color: #4F46E5;
    }

    .year-content {
        display: none;
    }

    .year-content.active {
        display: block;
    }

    .semester-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .semester-card {
        background: #F8FAFC;
        border: 2px solid #E2E8F0;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .semester-card:hover {
        border-color: #4F46E5;
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.1);
    }

    .semester-title {
        font-size: 16px;
        font-weight: 700;
        color: #1E293B;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #E2E8F0;
    }

    .fee-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 14px;
        color: #475569;
    }

    .fee-label {
        font-weight: 500;
    }

    .fee-value {
        font-weight: 600;
        color: #1E293B;
    }

    .total-fee {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #E2E8F0;
        display: flex;
        justify-content: space-between;
        font-size: 16px;
        font-weight: 700;
        color: #4F46E5;
    }

    .card-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #64748B;
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        color: #CBD5E1;
    }

    @media (max-width: 768px) {
        .filters-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group select {
            width: 100%;
        }

        .year-tabs {
            overflow-x: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class="bi bi-house-door"></i> Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Fee Structure</li>
    </ol>
</nav>

<!-- Action Bar -->
<div class="action-bar">
    <h2 style="margin: 0; font-size: 24px; color: #1E293B;">Fee Structure Management</h2>
    <a href="{% url 'fee_structure_create' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Add Fee Structure
    </a>
</div>

<!-- Filters -->
<div class="section-container">
    <form method="GET" class="filters-bar">
        <div class="filter-group">
            <label>Academic Year</label>
            <select name="academic_year" onchange="this.form.submit()">
                <option value="">All Years</option>
                {% for year in academic_years %}
                <option value="{{ year.id }}" {% if selected_year_id == year.id %}selected{% endif %}>
                    {{ year.year_code }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label>Programme</label>
            <select name="programme" onchange="this.form.submit()">
                <option value="">All Programmes</option>
                {% for prog in programmes %}
                <option value="{{ prog.id }}" {% if selected_programme_id == prog.id %}selected{% endif %}>
                    {{ prog.code }} - {{ prog.name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

<!-- Programme Tabs -->
{% if programme_fees %}
<div class="section-container">
    <div class="tabs-container">
        <div class="tabs-nav" id="programmeTabs">
            {% for prog_id, data in programme_fees.items %}
            <button class="tab-btn {% if forloop.first %}active{% endif %}" 
                    onclick="switchTab('prog-{{ prog_id }}')">
                {{ data.programme.code }}
            </button>
            {% endfor %}
        </div>

        {% for prog_id, data in programme_fees.items %}
        <div id="prog-{{ prog_id }}" class="tab-content {% if forloop.first %}active{% endif %}">
            <h3 style="color: #1E293B; margin-bottom: 15px;">
                {{ data.programme.name }}
                <span style="font-size: 14px; color: #64748B; font-weight: normal;">
                    ({{ data.academic_year.year_code }})
                </span>
            </h3>

            <!-- Year Tabs -->
            <div class="year-tabs">
                {% for year_level in data.programme.YEAR_LEVELS %}
                <div class="year-tab {% if forloop.first %}active{% endif %}" 
                     onclick="switchYearTab('prog-{{ prog_id }}', {{ year_level.0 }})">
                    Year {{ year_level.0 }}
                </div>
                {% endfor %}
            </div>

            <!-- Year Content -->
            {% for year_level in data.programme.YEAR_LEVELS %}
            <div id="prog-{{ prog_id }}-year-{{ year_level.0 }}" 
                 class="year-content {% if forloop.first %}active{% endif %}">
                
                {% with fee=data.year_levels|get_item:year_level.0 %}
                {% if fee %}
                <div class="semester-grid">
                    <!-- Semester 1 -->
                    <div class="semester-card">
                        <div class="fee-item">
                            <span class="fee-label">Other Fees:</span>
                            <span class="fee-value">KES {{ fee.other_fees|floatformat:2 }}</span>
                        </div>
                        <div class="total-fee">
                            <span>Total:</span>
                            <span>KES {{ fee.total_fee|floatformat:2 }}</span>
                        </div>
                    </div>

                    {% if data.programme.semesters_per_year == 3 %}
                    <!-- Semester 3 -->
                    <div class="semester-card">
                        <div class="semester-title">
                            <i class="bi bi-calendar3"></i> Semester 3
                        </div>
                        <div class="fee-item">
                            <span class="fee-label">Tuition Fee:</span>
                            <span class="fee-value">KES {{ fee.tuition_fee|floatformat:2 }}</span>
                        </div>
                        <div class="fee-item">
                            <span class="fee-label">Examination Fee:</span>
                            <span class="fee-value">KES {{ fee.examination_fee|floatformat:2 }}</span>
                        </div>
                        <div class="fee-item">
                            <span class="fee-label">Registration Fee:</span>
                            <span class="fee-value">KES {{ fee.registration_fee|floatformat:2 }}</span>
                        </div>
                        <div class="fee-item">
                            <span class="fee-label">Other Fees:</span>
                            <span class="fee-value">KES {{ fee.other_fees|floatformat:2 }}</span>
                        </div>
                        <div class="total-fee">
                            <span>Total:</span>
                            <span>KES {{ fee.total_fee|floatformat:2 }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-currency-dollar"></i>
                    <p>No fee structure defined for Year {{ year_level.0 }}</p>
                    <a href="{% url 'fee_structure_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add Fee Structure
                    </a>
                </div>
                {% endif %}
                {% endwith %}
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="section-container">
    <div class="empty-state">
        <i class="bi bi-currency-dollar"></i>
        <h3>No Fee Structures Found</h3>
        <p>Start by adding fee structures for your programmes</p>
        <a href="{% url 'fee_structure_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Fee Structure
        </a>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
function switchTab(tabId) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabId).classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

function switchYearTab(progId, yearLevel) {
    const prefix = progId + '-year-';
    
    // Hide all year contents for this programme
    document.querySelectorAll(`[id^="${prefix}"]`).forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active class from all year tabs in this programme
    event.target.parentElement.querySelectorAll('.year-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected year content
    document.getElementById(prefix + yearLevel).classList.add('active');
    
    // Add active class to clicked tab
    event.target.classList.add('active');
}

// Custom filter for getting dictionary item
document.addEventListener('DOMContentLoaded', function() {
    console.log('Fee structure page loaded');
});
</script>
{% endblock %}
